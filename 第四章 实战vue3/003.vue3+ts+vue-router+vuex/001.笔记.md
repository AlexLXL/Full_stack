### 第01讲 前置知识

> vue3.2 + ts + vue-router4.x + vuex4.x + vite2.x 后台管理系统.  
> element plus、EChart  依赖
>    
> 
> 视频地址: https://ke.qq.com/course/4124130  
> 样式参考: https://github.com/wmy19940613/vue-element-admin-master  
> 样式参考：https://github.com/PanJiaChen/vue-admin-template 
> 项目参考: https://juejin.cn/post/7042497481543778334
> 项目参考: https://github.com/RainManGO/vue3-composition-admin
> 项目参考: https://github.com/biaochenxuying/blog-vue-typescript (博客)

### 第02讲 创建项目

1.初始化项目

```
npm init vite@latest
npm i
npm run dev
```

这种方式生成的脚手架需要取消vue-tsc这个插件, 好像只支持vscode

package.json

```
+ "build2": "vite build",
```

2.解决: `npm run dev` 后终端输出 `Network: use '--host' to expose`

vite.config.js

```
+ server: {
+     host: '0.0.0.0',
+     port: 8080,
+     open: true
+ }
```

3.添加别名

vite.config.js

```
+import {resolve} from "path";

export default defineConfig({
+    resolve: {
+        alias: {
+            '@': resolve(__dirname, 'src')
+        }
+    },
})
```

tsconfig.js

ts文件使用别名的时候按下面规则寻址

```
+ "baseUrl": "./",
+ "paths": {
+   "@": ["src"],
+   "@/*": ["src/*"]
+ }
```

会提示依赖@types/node, `npm install @types/node -D`安装一下

### 第03讲 安装vue-router

1.安装路由

```
npm install vue-router@4
```

src/router/index.ts

```
+ import { createRouter, createWebHistory, RouteRecordRaw } from 'vue-router'
+ import Home from '@/components/HelloWorld.vue'
+ 
+ const routes: Array<RouteRecordRaw> = [
+   {
+     path: '/',
+     name: 'Home',
+     component: Home
+   }
+ ]
+ 
+ const router = createRouter({
+   history: createWebHistory(),
+   routes
+ })
+ 
+ export default router
```

App.vue

```
+ <template>
+   <router-view></router-view>
+ </template>
```

main.ts

```
+ import router from "./router";

+ createApp(App).use(router).mount('#app')
```

### 第04讲 安装vuex(支持typescript)

```
npm install vuex@next -S
```

src/store/index.ts

```
import { InjectionKey } from 'vue'
import { createStore, useStore as baseUseStore, Store } from 'vuex'

export interface State {
  count: number
}

export const key: InjectionKey<Store<State>> = Symbol()

export const store = createStore<State>({
  state: {
    count: 0
  },
  mutations: {
    setCount(state: State, v: number) {
      state.count = v
    }
  },
  getters: {
    getCount(state: State): number {
      return state.count
    }
  }
})

// 定义自己的 `useStore` 组合式函数
export function useStore () {
  return baseUseStore(key)
}
```

src/components/HelloWorld.vue

```
<template>
+  <h2>{{showCount}}</h2>
+  <button @click="addBtn">+</button>
</template>

<script lang="ts">
  import { ref, computed, defineComponent } from 'vue'
  import { useStore } from 'vuex'
  import { key } from '@/store'

  export default defineComponent({
+    setup() {
+      const store = useStore(key)
+      const count = ref(0)
+      const showCount = computed(() => {
+        return store.getters.getCount
+      })
+      const addBtn = () => {
+        store.commit('setCount', ++count.value)
+      }
+      return {
+        showCount,
+        addBtn
+      }
+    }
  });
</script>
```

### 第05讲 安装eslint、sass

1.安装eslint

更完整安装eslint也可以参考 `打包Vite的笔记`

```
npm install eslint eslint-plugin-vue
```

.eslintrc.js

```
module.exports = {
  // 默认情况下，ESLint会在所有父级组件中寻找配置文件，一直到根目录。
  // ESLint一旦发现配置文件中有 "root": true，它就会停止在父级目录中寻找。
  root: true,
  parserOptions: {
    // 代码是 ECMAScript 模块
    sourceType: 'module',
    // 对Babel解析器的包装使其与 ESLint 兼容。
    // parser: 'babel-eslint'
  },
  env: {
     // 预定义的全局变量，这里是浏览器环境
    browser: true,
    node: true,
    es6: true,
  },
  // 扩展风格
  extends: [
      'plugin:vue/vue3-essential',
      'plugin:vue/vue3-strongly-recommended',
      'plugin:vue/vue3-recommended'
  ],
  // 规则的细节请到ESLint官方网站查看https://eslint.org/docs/rules/
  rules: {
    // 禁用 console
    'no-console': 'off',
    // 禁止使用拖尾逗号
    'comma-dangle': [2, 'never']
  }
}
```

2.安装sass

```
npm install sass sass-loader -D
```

src/components/HelloWorld.vue

```
<style scoped lang="scss">
$color: green;
h2 {
  color: $color;
}
</style>
```

### 第06讲 引入element plus

1.安装依赖

```
npm install element-plus --save
```

main.ts

```
// main.ts
import { createApp } from 'vue'
import App from './App.vue'
+ import ElementPlus from 'element-plus'
+ import 'element-plus/dist/index.css'

const app = createApp(App)
+ app.use(ElementPlus)
app.mount('#app')
```

src/components/HelloWorld.vue

```
<el-row>
    <el-button>Default</el-button>
    <el-button type="primary">Primary</el-button>
    <el-button type="success">Success</el-button>
    <el-button type="info">Info</el-button>
    <el-button type="warning">Warning</el-button>
    <el-button type="danger">Danger</el-button>
    <el-button>中文</el-button>
  </el-row>
```

2.打包报错的话添加配置

tsconfig.js

```
"skipLibCheck": true, // 解决打包时候的报错, 忽略*.d.ts的声明文件
```

### 第07讲 项目主页面布局

public/init.scss（初始化样式）

```
html, body, div, h1, h2, h3, h4, h5, h6, p, dl, dt, dd, ol, ul, li, fieldset, form, label, input, legend, table, caption, tbody, tfoot, thead, tr, th, td, textarea, article, aside, audio, canvas, figure, footer, header, mark, menu, nav, section, time, video { margin: 0; padding: 0; }
h1, h2, h3, h4, h5, h6 { font-size: 100%; font-weight: normal }
article, aside, dialog, figure, footer, header, hgroup, nav, section, blockquote { display: block; }
ul, ol { list-style: none; }
img { border: 0 none; vertical-align: top; }
blockquote, q { quotes: none; }
blockquote:before, blockquote:after, q:before, q:after { content: none; }
table { border-collapse: collapse; border-spacing: 0; }
strong, em, i { font-style: normal; font-weight: normal; }
ins { text-decoration: underline; }
del { text-decoration: line-through; }
mark { background: none; }
input::-ms-clear { display: none !important; }
body { font: 12px/1.5 \5FAE\8F6F\96C5\9ED1, \5B8B\4F53, "Hiragino Sans GB", STHeiti, "WenQuanYi Micro Hei", "Droid Sans Fallback", SimSun, sans-serif; background: #fff; }
a { text-decoration: none; color: #333; }
a:hover { text-decoration: underline; }
```

src/App.vue

```
+ <style lang="scss">
+   @import "../public/css/init.scss";
+   html, body, #app {
+     height: 100%;
+   }
+ </style>
```

src/layout/index.vue（基础布局）

```
<template>
  <el-container class="layout">
    <el-aside width="200px" class="aside">Aside</el-aside>
    <el-container>
      <el-header class="header">Header</el-header>
      <el-main class="main">Main</el-main>
    </el-container>
  </el-container>
</template>

<script lang="ts">
export default {
  name: "index"
}
</script>

<style lang="scss" scoped>
  .layout {
    height: 100%;
    .aside {
      background-color: aquamarine;
    }
    .header {
      background-color: blueviolet;
    }
    .main {
      background-color: darkgray;
    }
  }
</style>
```

src/router/index.ts（修改默认路由为layout）

```
+ import Home from '@/layout/index.vue'

const routes: Array<RouteRecordRaw> = [
+  {
+    path: '/',
+    name: 'Home',
+    component: Home
+  }
]
```

### 第08讲 左侧导航菜单制作讲解1

前置知识: 引入组件方式

```
// 全局注册 main.js
import { createApp } from 'vue';
import ComA from './components/ComA.vue';
import App from './App.vue';
const app = createApp(App);
app.component('com-a', ComA);
app.mount('#app');
 
至此可以在任意地方使用<com-a>组件
 
// 局部注册
import {defineComponent} from 'vue';
import ComA from './components/ComA.vue';
export default defineComponent({
    name: 'App',
    components: {
        ComA
    },
    setup() {
        return {};
    }
});

======================注册异步组件==================

// defineAsyncComponent
import {defineComponent, defineAsyncComponent} from 'vue';
export default defineComponent({
    name: 'App',
    components: {
        ComA: defineAsyncComponent(() => import('./components/ComA.vue'));
    },
    setup() {
        return {};
    }
});

======================vue3.2语法糖===================

在vue3.2 setup语法糖里，直接引入来用就好，不用注册

```

src/layout/menu/MenuBar.vue

```
<template>
  <el-menu
      default-active="2"
      class="el-menu-vertical-demo"
      :collapse="isCollapse"
      @open="handleOpen"
      @close="handleClose"
  >
    <el-sub-menu index="1">
      <template #title>
        <el-icon>
          <location/>
        </el-icon>
        <span>Navigator One</span>
      </template>
      <el-menu-item-group>
        <template #title><span>Group One</span></template>
        <el-menu-item index="1-1">item one</el-menu-item>
        <el-menu-item index="1-2">item two</el-menu-item>
      </el-menu-item-group>
      <el-menu-item-group title="Group Two">
        <el-menu-item index="1-3">item three</el-menu-item>
      </el-menu-item-group>
      <el-sub-menu index="1-4">
        <template #title><span>item four</span></template>
        <el-menu-item index="1-4-1">item one</el-menu-item>
      </el-sub-menu>
    </el-sub-menu>
    <el-menu-item index="2">
      <el-icon>
        <icon-menu/>
      </el-icon>
      <template #title>Navigator Two</template>
    </el-menu-item>
    <el-menu-item index="3" disabled>
      <el-icon>
        <document/>
      </el-icon>
      <template #title>Navigator Three</template>
    </el-menu-item>
    <el-menu-item index="4">
      <el-icon>
        <setting/>
      </el-icon>
      <template #title>Navigator Four</template>
    </el-menu-item>
  </el-menu>
</template>
<script lang="ts">
import {ref, computed, defineComponent} from 'vue'
import {
  Location,
  Document,
  Menu as IconMenu,
  Setting,
} from '@element-plus/icons-vue'

export default defineComponent({
  name: "Aside",
  setup() {
    const isCollapse = ref(false)
    const handleOpen = (key: string, keyPath: string[]) => {
      console.log(key, keyPath)
    }
    const handleClose = (key: string, keyPath: string[]) => {
      console.log(key, keyPath)
    }
    return {
      isCollapse,
      handleOpen,
      handleClose
    }
  },
  components: {
    Location,
    Document,
    IconMenu,
    Setting
  }
});
</script>

<style lang="scss" scoped>
.el-menu-vertical-demo:not(.el-menu--collapse) {
  width: 200px;
  min-height: 400px;
}
</style>
```

src/layout/header/Header.vue

```
<template>
  <div>header区域</div>
</template>
<script lang="ts">
export default {
  name: "Header"
}
</script>
<style lang="scss" scoped></style>
```

src/layout/main/Main.vue

```
<template>
  <div>Main区域</div>
</template>
<script lang="ts">
export default {
  name: "Main"
}
</script>
<style lang="scss" scoped></style>
```

src/layout/index.vue

```
<template>
  <el-container class="layout">
    <el-aside width="200px" class="aside">
+      <MenuBar></MenuBar>
    </el-aside>
    <el-container>
      <el-header class="header">
+        <Header></Header>
      </el-header>
      <el-main class="main">
+        <Main></Main>
      </el-main>
    </el-container>
  </el-container>
</template>

<script lang="ts">
+ import MenuBar from "@/layout/menu/MenuBar.vue"
+ import Header from "@/layout/header/Header.vue"
+ import Main from "@/layout/main/Main.vue"

export default {
  name: "index",

+  components: {
+    MenuBar,
+    Header,
+    Main
+  }
}
</script>
```

### 第09讲 左侧导航菜单制作讲解2（完善）

1.抽离el-sub-menu、el-menu-item 为MenuItem

src/layout/MenuItem  
利用递归组件,生成菜单

```
<template>
  <template v-for="menu in menuList" :key="menu.path">
    <el-sub-menu v-if="menu.children && menu.children.length" :index="menu.path">
      <template #title>
        <el-icon>
          <Icon :icon="menu.meta.icon2" />
        </el-icon>
        <span>{{menu.meta.title}}</span>
      </template>
      <MenuItem :menuList="menu.children"></MenuItem>
    </el-sub-menu>
    <el-menu-item v-else :index="menu.path">
      <el-icon>
        <Icon :icon="menu.meta.icon2" />
      </el-icon>
      <template #title>{{menu.meta.title}}</template>
    </el-menu-item>
  </template>
</template>
<script lang="ts">
import {defineComponent} from 'vue'

export default defineComponent({
  name: "MenuItem",
  props: ['menuList'],
  setup() {
    return {}
  },
});
</script>

<style lang="scss" scoped></style>
```

2.父组件传值

src/menu/MenuBar

```

<template>
  <el-menu
      default-active="2"
      class="el-menu-vertical-demo"
      :collapse="isCollapse"
      background-color="#304156"
      @open="handleOpen"
      @close="handleClose"
  >
+    <MenuItem :menuList="menuList"></MenuItem>
  </el-menu>
</template>

<script lang="ts">
+ import MenuItem from "@/layout/menu/MenuItem.vue";

+ export default defineComponent({
+   name: "MenuBar",
+   setup(prop) {
+     let menuList = reactive([
+       {
+         path: '/dashboard',
+         component: 'Layout',
+         meta: {
+           title: '首页',
+           icon: 'el-icon-s-home',
+           icon2: 'HomeFilled',
+           roles: ['sys:manage']
+         },
+         children: []
+       },
+       {
+         path: '/system',
+         component: 'Layout',
+         alwaysShow: true,
+         name: 'system',
+         meta: {
+           title: '系统管理',
+           icon: 'el-icon-menu',
+           icon2: 'Menu',
+           roles: ['sys:manage'],
+           parentId: 0
+         },
+         children: [
+           {
+             path: '/department',
+             component: '/system/department/department',
+             alwaysShow: false,
+             name: 'department',
+             meta: {
+               title: '机构管理',
+               icon: 'el-icon-document',
+               icon2: 'Document',
+               roles: ['sys:dept'],
+               parentId: 17
+             },
+           },
+           {
+             path: '/userList',
+             component: '/system/User/UserList',
+             alwaysShow: false,
+             name: 'userList',
+             meta: {
+               title: '用户管理',
+               icon: 'el-icon-s-custom',
+               icon2: 'UserFilled',
+               roles: ['sys:user'],
+               parentId: 17
+             }
+           },
+           {
+             path: '/roleList',
+             component: '/system/Role/RoleList',
+             alwaysShow: false,
+             name: 'roleList',
+             meta: {
+               title: '角色管理',
+               icon: 'el-icon-s-tools',
+               icon2: 'Tools',
+               roles: ['sys:role'],
+               parentId: 17
+             },
+           },
+           {
+             path: '/menuList',
+             component: '/system/Menu/MenuList',
+             alwaysShow: false,
+             name: 'menuList',
+             meta: {
+               title: '权限管理',
+               icon: 'el-icon-document',
+               icon2: 'Document',
+               roles: ['sys:menu'],
+               parentId: 17
+             },
+           }
+         ]
+       },
+       {
+         path: '/goods',
+         component: 'Layout',
+         alwaysShow: true,
+         name: 'goods',
+         meta: {
+           title: '商品管理',
+           icon: 'el-icon-document',
+           icon2: 'Document',
+           roles: ['sys:goods'],
+           parentId: 0,
+         },
+         children: [
+           {
+             path: '/goodcategory',
+             component: 'goods/goodsCategory/goodscategoryList',
+             alwaysShow: false,
+             name: 'goodcategory',
+             meta: {
+               title: '商品分类',
+               icon: 'el-icon-document',
+               icon2: 'Document',
+               roles: ['sys:goodsCategory'],
+               parentId: 34
+             },
+           }
+         ]
+       },
+       {
+         path: '/systenconfig',
+         component: 'Layout',
+         alwaysShow: true,
+         name: 'systenconfig',
+         meta: {
+           title: '系统工具',
+           icon: 'el-icon-document',
+           icon2: 'Document',
+           roles: ['sys:systenconfig'],
+           parentId: 0,
+         },
+         children: [
+           {
+             path: '/document',
+             component: '/system/config/systemDocument',
+             alwaysShow: false,
+             name: 'https://42.193.158.170：8089/swagger-ui/index.html',
+             meta: {
+               title: '接口文档',
+               icon: 'el-icon-document',
+               icon2: 'Document',
+               roles: ['sys:document'],
+               parentId: 42
+             },
+           }
+         ]
+       },
+     ])
+     return {
+       menuList
+     }
+   },
+   components: {
+     MenuItem
+   }
+ });
</script>
```

3.添加样式

src/layout/index.vue

```
.aside {
  background-color: rgb(48, 65, 86);
}
.header {
  height: 50px;
  border-bottom: 1px solid #e5e5e5;
}
```

src/layout/menu/MenuBar.vue

```
<el-menu
  default-active="2"
  class="el-menu-vertical-demo"
  :collapse="isCollapse"
+  background-color="#304156"
  @open="handleOpen"
  @close="handleClose"
>


<style lang="scss" scoped>
.el-menu-vertical-demo:not(.el-menu--collapse) {
  width: 200px;
  min-height: 400px;
}
.el-menu {
  border-right: none;
}
.el-menu--collapse {
  border-right: none;
}
::v-deep .el-sub-menu .el-sub-menu__title {
  color: #ffffff !important;
}
::v-deep .el-menu-item {
  color: #ffffff;
}
::v-deep .el-menu .el-menu-item {
  color: #bfcbd9;
}
::v-deep .el-menu-item.is-active {
  color:  #4093ff !important;
}
::v-deep .is-opened .el-menu-item {
  background-color: #1f2d3d !important;
}
::v-deep .el-menu-item:hover {
  background-color: #001528 !important;
}
</style>
```

知识点:  

4.element plus 更新后动态icon的使用

https://blog.csdn.net/pdd11997110103/article/details/121440220

```
需要使用  
<component class="xxx" :is="iconName"></component>

或  

自己一个组件, 动态注册需要的icon, 通过prop传据图icon名称
```

5.::v-deep、>>>、/deep/

https://www.jianshu.com/p/72a9e0dfdfb4

作用就是样式穿透子组件

### 第10讲 菜单路由

1.src/router/index.ts（添加路由）

```
const routes: Array<RouteRecordRaw> = [
  {
    path: '/',
    component: Layout,
    name: 'Layout',
    redirect: '/homepage',
    children: [
      {
        path: '/homepage',
        component: () => import('@/layout/homepage/Index.vue'),
        name: 'homepage',
        meta: {
          title: '首页',
          icon: '#icondashboard'
        }
      }
    ]
  },
  {
    path: '/system',
    component: Layout,
    name: 'system',
    meta: {
      title: '系统管理',
      icon: 'el-icon-menu',
      roles: ['sys:manage'],
      parentId: 0
    },
    children: [
      {
        path: '/department',
        component: () => import('@/views/system/department/Department.vue'),
        name: 'department',
        meta: {
          title: '机构管理',
          icon: 'el-icon-document',
          roles: ['sys:dept']
        }
      },
      {
        path: '/userList',
        component: () => import('@/views/system/user/UserList.vue'),
        name: 'userList',
        meta: {
          title: '用户管理',
          icon: 'el-icon-s-custom',
          roles: ['sys:user']
        }
      },
      {
        path: '/roleList',
        component: () => import('@/views/system/role/RoleList.vue'),
        name: 'roleList',
        meta: {
          title: '角色管理',
          icon: 'el-icon-s-tools',
          roles: ['sys:role']
        }
      },
      {
        path: '/menuList',
        component: () => import('@/views/system/menu/MenuList.vue'),
        name: 'menuList',
        meta: {
          title: '权限管理',
          icon: 'el-icon-document',
          roles: ['sys:menu']
        }
      }
    ]
  },
  {
    path: '/goods',
    component: Layout,
    name: 'goods',
    meta: {
      title: '商品管理',
      icon: 'el-icon-document',
      roles: ['sys:goods']
    },
    children: [
      {
        path: '/goodCategory',
        component: () => import('@/views/goods/goodCategory/goodCategoryList.vue'),
        name: 'goodCategory',
        meta: {
          title: '商品分类',
          icon: 'el-icon-document',
          roles: ['sys:goodCategory']
        }
      }
    ]
  },
  {
    path: '/systemConfig',
    component: Layout,
    name: 'systemConfig',
    meta: {
      title: '系统工具',
      icon: 'el-icon-document',
      roles: ['sys:systemConfig']
    },
    children: [
      {
        path: '/document',
        component: () => import('@/views/system/config/systemConfig.vue'),
        name: 'https://42.193.158.170：8089/swagger-ui/index.html',
        meta: {
          title: '接口文档',
          icon: 'el-icon-document',
          roles: ['sys:document']
        }
      }
    ]
  },
]
```

2.新建路由里的各个页面

```
<template>
  接口文档展示
</template>
<script lang="ts" setup></script>
<style lang="scss" scoped></style>
```

3.启用element plus的menu的路由模式

src/layout/menu/MenuBar.vue

```
<el-menu
  default-active="2"
  class="el-menu-vertical-demo"
  :collapse="isCollapse"
  background-color="#304156"
+  :router="true"
  @open="handleOpen"
  @close="handleClose"
>
<MenuItem :menuList="menuList"></MenuItem>
</el-menu>
```

4.F5刷新页面的时候保持路由

src/layout/menu/MenuBar.vue

```
<template>
    <el-menu
+     :default-active="activeIndex"
      class="el-menu-vertical-demo"
      :collapse="isCollapse"
      background-color="#304156"
      :router="true"
      @open="handleOpen"
      @close="handleClose"
    >
    <MenuItem :menuList="menuList"></MenuItem>
    </el-menu>
</template>

<srcipt lang="ts">
import {useRoute} from "vue-router";
import {computed} from 'vue'

export default defineComponent({
    setup() {
        let {path} = useRoute()
        let activeIndex = computed(() => {
          return path
        })
        return {
            activeIndex
        }
    }
})
</srcipt>
```

### 第11讲 菜单的收缩和展开

1.添加折叠图标组件

src/layout/header/Collapse.vue

```
<template>
  <el-icon @click="handleCollapse">
    <Icon :icon="getCollapse ? 'Fold' : 'Expand'" />
  </el-icon>
</template>
<script lang="ts" setup>
  import {useStore} from "@/store";
  import {computed} from 'vue'

  let store = useStore()
  let getCollapse = computed(() => {
    return store.getters['getCollapse']
  })
  let handleCollapse = () => {
    store.commit('setCollapse', !getCollapse.value)
  }
</script>

<style lang="scss" scoped>
  .el-icon {
    font-size: 20px;
    cursor: pointer;
    color: #303123;
  }
</style>
```

2.定义vuex变量

src/store/index.ts

```
export interface State {
  count: number,
+  collapse: boolean
}

export const key: InjectionKey<Store<State>> = Symbol()

export const store = createStore<State>({
  state: {
    count: 0,
+    collapse: false
  },
  mutations: {
    setCount(state: State, v: number) {
      state.count = v
    },
+    setCollapse(state: State, v: boolean) {
+      state.collapse = v
+    }
  },
  getters: {
    getCount(state: State): number {
      return state.count
    },
+    getCollapse(state: State): boolean {
+      return state.collapse
+    }
  }
})
```

3.菜单栏使用vuex的变量

src/layout/menu/MenuBar.vue

```
<el-menu
  :default-active="activeIndex"
  class="el-menu-vertical-demo"
+  :collapse="isCollapse"
  background-color="#304156"
  :router="true"
  @open="handleOpen"
  @close="handleClose"
>

=====================================================

import {computed} from 'vue'
import {useStore} from "@/store";

let store = useStore()
let isCollapse = computed(() => {
  return store.getters['getCollapse']
})
```

### 第12讲 面包屑导航

1.添加面包屑组件，样式，引入

src/layout/header/BreadCrumb.vue

用到了断言和泛型

```
<template>
  <el-breadcrumb separator="/">
    <el-breadcrumb-item v-for="tab in tabs">{{tab.meta.title}}</el-breadcrumb-item>
  </el-breadcrumb>
</template>
<script lang="ts" setup>
  import { useRoute, RouteLocationMatched, onBeforeRouteUpdate } from 'vue-router'
  import { ref, Ref, watch } from 'vue'

  let tabs: Ref<RouteLocationMatched[]> = ref([])
  let route = useRoute()
  let getBreadCrum = () => {
    let matched = route.matched.filter(item => item.meta && item.meta.title)
    if(matched[0].path !== '/homepage') {
      matched = [{path: '/homepage', meta: {title: '首页'}} as any].concat(matched)
    }
    tabs.value = matched
  }
  getBreadCrum()

  watch(() => route.path, () => {
    getBreadCrum()
  })
</script>

<style lang="scss" scoped></style>
```

src/layout/header/Header.vue

```
<template>
  <div class="header">
    <Collapse></Collapse>
+    <BreadCrum></BreadCrum>
  </div>
</template>
<script lang="ts" setup>
import Collapse from "@/layout/header/Collapse.vue"
+ import BreadCrum from "@/layout/header/BreadCrum.vue"
</script>
```

3.知识点

3.1 指定ref类型

```
import {ref} from 'vue'
let a: Ref<string[]> = ref(['a', 'b'])
```

3.2 尝试使用路由守卫代替监听路由

问题1: vue3.2的setup语法糖导致无法设置beforeRouteEnter, 因为setup是替代created生命周期的

问题2: onBeforeRouteUpdate能监听子路由变化，但无法监听同级别路由变化

### 第13讲 Tab选项卡

1.添加组件src/layout/tab/Tabs.vue、添加样式、引用

src/layout/tab/Tabs.vue

使用了vuex存储tabList

```
<template>
  <el-tabs
    v-model="activedTab"
    type="card"
    closable
    @tab-click="handleClick"
    @tab-remove="removeTab"
  >
    <el-tab-pane
      v-for="item in tabList"
      :key="item.path"
      :label="item.name"
      :name="item.path"
    >
    </el-tab-pane>
  </el-tabs>
</template>
<script lang="ts" setup>
  import { store } from '@/store'
import { ITab } from '@/store/type'
  import {ref, computed, watch, onMounted} from 'vue'
  import {useRoute, useRouter} from 'vue-router'

  let route = useRoute()
  let router = useRouter()
  let activedTab = ref('')
  let tabList = computed(() => {
    return store.getters['getTabList']
  })
  const removeTab = (targetName: string) => {
    const tabs = tabList.value
    let activeName  = activedTab.value
    if (activeName === targetName) {
      tabs.forEach((tab: ITab, index: number) => {
        if (tab.path === targetName) {
          const nextTab = tabs[index + 1] || tabs[index - 1]
          if (nextTab) activeName = nextTab.path
        }
      })
    } 
    console.log(activeName)
    activedTab.value = activeName
    store.commit('removeTabList', {path: targetName, name: ''})
    router.push({path: activeName})
  }
  const addTab = () => {
    store.commit('addTabList', {path: route.path, name: route.meta.title as string})
  }
  const setActivedTab = () => {
    activedTab.value = route.path
  }
  const handleClick = (tab: any) => {
    let {props} = tab
    router.push({path: props.name})
  }
  const refreshPage = () => {
    window.addEventListener('beforeunload', () => {
      sessionStorage.setItem('tabList', JSON.stringify(tabList.value))
    })
    let tabListSession = sessionStorage.getItem('tabList')
    if(tabListSession) {
      let oldTabList = JSON.parse(tabListSession)
      oldTabList && store.commit('setTabList', oldTabList)
    }
  }

  onMounted(() => {
    setActivedTab()
    refreshPage()
  })
  watch(() => route.path, () => {
    addTab()
    setActivedTab()
  })
</script>

<style lang="scss" scoped>
 :deep(.e1-tabsheader) {
   margin: 0
 }
 :deep(.el-tabs__item) {
   height: 26px !important;
   line-height: 26px !important;
   color: #495060;
   font-size: 12px !important;
   text-align: center;
   padding: 0 10px !important;
   border: 1px solid #d8dce5 !important;
   margin: 0 3px !important;
 }
 :deep(.el-tabs_nav) {
   border: none !important;
 }
 :deep(.is-active) {
   color: #fff !important;
   border: 1px solid #42b983 !important;
   border-bottom: 1px solid transparent !important;
   background-color: #42b983 !important;
 }
 :deep(.el-tabs_item:hover) {
   color: #495060 !important;
 }
  :deep(.is-active:hover) {
   color: #fff !important;
 }
</style>
```

src/layout/index.vue（引入tab）

```
<template>
  <el-container class="layout">
    <el-aside class="aside">
      <MenuBar></MenuBar>
    </el-aside>
    <el-container>
      <el-header class="header">
        <Header></Header>
      </el-header>
      <el-main class="main">
+        <Tabs></Tabs>
        <router-view v-slot="{ Component }">
          <keep-alive>
            <component :is="Component" />
          </keep-alive>
        </router-view>
      </el-main>
    </el-container>
  </el-container>
</template>
<script lang="ts">
+ import Tabs from "@/layout/tab/Tabs.vue"

export default {
  components: {
+    Tabs
  }
}
</script>
```

2.数据和事件
- 使用vuex存储tabs（添加interface类型）
- 通过监听路由来添加tabs激活tab（看第一点）
- 删除就直接用事件、点击tab跳转路由（看第一点）

src/store/index.ts

```
export interface State {
  count: number,
  collapse: boolean,
+  tabList: ITab[]
}

export const store = createStore<State>({
  state: {
    count: 0,
    collapse: false,
+    tabList: []
  },
  mutations: {
+    addTabList(state: State, v: ITab) {
+      if(state.tabList.some(item => item.path === v.path)) return
+      state.tabList.push(v)
+    },
+    removeTabList(state: State, v: ITab) {
+      state.tabList = state.tabList.filter(item => item.path !== v.path)
+    },
+    setTabList(state: State, v: ITab[]) {
+      state.tabList = v
+    }
  },
  getters: {
+    getTabList(state: State): ITab[] {
+      return state.tabList
+    }
  }
})
```

src/store/type/index.ts

```
export interface ITab {
  path: string,
  name: string
}
```

3.F5刷新保留激活tab（F5刷新存在sessionStorage里）

技术点:
- onMounted
- window.addEventListener("beforeunload")
- sessionStorage.setItem('tabList', JSON.stringify(xxx))
- sessionStorage.getItem('tabList')
- JSON.parse()

src/layout/tab/index.vue

```
const refreshPage = () => {
    window.addEventListener('beforeunload', () => {
        sessionStorage.setItem('tabList', JSON.stringify(tabList.value))
    })
    let tabListSession = sessionStorage.getItem('tabList')
    if(tabListSession) {
        let oldTabList = JSON.parse(tabListSession)
        oldTabList && store.commit('setTabList', oldTabList)
    }
}

onMounted(() => {
    setActivedTab()
    refreshPage()
})
```

### 第14讲 TypeScript

接下来章节需要有TS的: interface/type(keyof、typeof)/泛型(泛型约束)/
交叉类型、联合类型/Omit/Pick/Parameters/ReturnType基础

### 第15讲 Vuex4+TypeScript实现类型推测1

- 目的: 调用dispatch/commit/getters的时候有代码提示
- 过程: 改为只用modules + 命名空间namespaced的方式
- 结果: 还是只能在vscode有提示，webstorm不支持
- 附录: 单文件（不分modules）想要代码提示可看`002.资料的ts-test`

src/store/modules/tabs.ts（抽取）

```
import { ITab } from '../type'

//定义state
export type TabState = {
  tabList: ITab[]
}
export const state: TabState = {
  tabList: []
}

//定义actions
export const actions = {}

//定义mutations
export const mutations = {
  addTabList(state: TabState, v: ITab) {
    if(state.tabList.some(item => item.path === v.path)) return
    state.tabList.push(v)
  },
  removeTabList(state: TabState, v: ITab) {
    state.tabList = state.tabList.filter(item => item.path !== v.path)
  },
  setTabList(state: TabState, v: ITab[]) {
    state.tabList = v
  }
}

//定义getters
export const getters = {
  getTabList(state: TabState): ITab[] {
    return state.tabList
  }
}
export default {
  namespaced: true,
  state,
  mutations,
  actions,
  getters
}

```

src/store/modules/menu.ts（抽取）

```
//定义state
export type MenuState = {
  count: number,
  collapse: boolean,
}
export const state: MenuState = {
  count: 0,
  collapse: false,
}

//定义actions
export const actions = {}

//定义mutations
export const mutations = {
  setCount(state: MenuState, count: number) {
    state.count = count;
  },
  setCollapse: (state: MenuState, collapse: boolean) => {
    state.collapse = collapse;
  }
}

//定义getters
export const getters = {
  getCount(state: MenuState) {
    return state.count;
  },
  getCollapse: (state: MenuState) => {
    return state.collapse;
  }
}
export default {
  namespaced: true,
  state,
  mutations,
  actions,
  getters
}
```

src/store/index.ts（使用modules+namespaced的方式）

```
// import { InjectionKey } from 'vue'
// import { createStore, useStore as baseUseStore, Store } from 'vuex'
// import { ITab } from './type'

// export interface State {
//   count: number,
//   collapse: boolean,
//   tabList: ITab[]
// }

// export const key: InjectionKey<Store<State>> = Symbol()

// export const store = createStore<State>({
//   state: {
//     count: 0,
//     collapse: false,
//     tabList: []
//   },
//   mutations: {
//     setCount(state: State, v: number) {
//       state.count = v
//     },
//     setCollapse(state: State, v: boolean) {
//       state.collapse = v
//     },
//     addTabList(state: State, v: ITab) {
//       if(state.tabList.some(item => item.path === v.path)) return
//       state.tabList.push(v)
//     },
//     removeTabList(state: State, v: ITab) {
//       state.tabList = state.tabList.filter(item => item.path !== v.path)
//     },
//     setTabList(state: State, v: ITab[]) {
//       state.tabList = v
//     }
//   },
//   getters: {
//     getCount(state: State): number {
//       return state.count
//     },
//     getCollapse(state: State): boolean {
//       return state.collapse
//     },
//     getTabList(state: State): ITab[] {
//       return state.tabList
//     }
//   }
// })

// // 定义自己的 `useStore` 组合式函数
// export function useStore () {
//   return baseUseStore(key)
// }

// store.ts
import {InjectionKey} from 'vue'
import {createStore, useStore as baseUseStore, Store} from 'vuex'
import tabs, {TabState} from '../store/modules/tabs'
import menu, {MenuState} from '../store/modules/menu'
import {CommonStore} from './help'

//是一种规范
export type RootState = {
  tabs: TabState,
  menu: MenuState,
}
//导入所有的模块
export const modules = {
  tabs: tabs,
  menu: menu,
}
export const key: InjectionKey<Store<RootState>> = Symbol()

export const store = createStore<RootState>({
  modules
}) as CommonStore

// 定义自己的 `useStore` 组合式函数
export function useStore() {
  return baseUseStore(key) as CommonStore
}
```

src/store/help.ts（添加代码提示）

```
import {CommitOptions, DispatchOptions, Store as VuexStore} from 'vuex'
import {modules, RootState} from './index'

//获取modules的类型
type Modules = typeof modules
//获取所有模块下的mutations
type GetMutation<T> = T extends { mutations: infer G } ? G : never;
type GetMutations<T> = {
  [K in keyof T]: GetMutation<T[K]>
}
type mutationsObj = GetMutations<Modules>
//获取所有模块下的actions
type GetAction<T> = T extends { actions: infer G } ? G : never;
type GetActions<T> = {
  [K in keyof T]: GetAction<T[K]>
}
type actionsObj = GetActions<Modules>
//获取所有模块下的getters
type GetGetter<T> = T extends { getters: infer G } ? G : never;
type GetGetters<T> = {
  [K in keyof T]: GetGetter<T[K]>
}
type gettersObj = GetGetters<Modules>

//  tabs/addTabe  menu/setCount
type AddPrefix<prefix, keys> = `${prefix & string}/${keys & string}`
type Getkey<T, K> = AddPrefix<K, keyof T>;
type Getkeys<T> = {
  [K in keyof T]: Getkey<T[K], K>
}[keyof T]

// type ss = Getkeys<mutationsObj>

//获取当前模块下每个函数的返回值
type GetFunc<T, A, B> = T[A & keyof T][B & keyof T[A & keyof T]];
type GetMethod<T> = {
  [K in Getkeys<T>]: K extends `${infer A}/${infer B}` ? GetFunc<T, A, B> : unknown
}

type GetMutationsFunc = GetMethod<mutationsObj>;
type GetActionsFunc = GetMethod<actionsObj>;
type GetGettersFunc = GetMethod<gettersObj>;

export type CommonStore = Omit<VuexStore<RootState>, 'commit' | 'getters' | 'dispatch'>
  &
  {
    commit<K extends keyof GetMutationsFunc, P extends Parameters<GetMutationsFunc[K]>[1]>(
      key: K,
      payload?: P,
      options?: CommitOptions
    ): ReturnType<GetMutationsFunc[K]>
  }
  &
  {
    getters: {
      [K in keyof GetGettersFunc]: ReturnType<GetGettersFunc[K]>
    }
  }
  &
  {
    dispatch<K extends keyof GetActionsFunc>(
      key: K,
      payload?: Parameters<GetActionsFunc[K]>[1],
      options?: DispatchOptions
    ): ReturnType<GetActionsFunc[K]>
  }
```

### 第16讲 axios的安装与使用

1.安装axios和qs

```
npm install axios
npm install --save @types/qs
npm i qs -S
```

2.src/http/ajax.ts

```
import axios, {AxiosInstance, AxiosRequestConfig, AxiosResponse} from "axios";
import {ElMessage} from "element-plus";
import {getToken} from "@/utils/auth";
import qs from 'qs'

export interface Result<T = any> {
  code: number;
  msg: string;
  data: T;
}

enum StatusCode {
  NoAuth = 600, //token失效
  Success = 200 //返回成功
}

class Request {
  private axiosInstance: AxiosInstance;
  private defaultConfig: AxiosRequestConfig = {
    headers: {'Content-Type': 'application/json'}
  };

  constructor(config: AxiosRequestConfig) {
    // 创建axios实例
    this.axiosInstance = axios.create(config)
    // axios默认配置
    this.defaults()
    // axios拦截器
    this.interceptors()
  }

  private defaults() {
    this.axiosInstance.defaults.headers.post['X-Requested-With'] = 'XMLHttpRequest'
    this.axiosInstance.defaults.headers.get['X-Requested-With'] = 'XMLHttpRequest'
    // this.axiosInstance.defaults.headers['Content-Type'] = 'application/x-www-form-urlencoded'
    this.axiosInstance.defaults.responseType = 'json'
    this.axiosInstance.defaults.transformRequest = [
      (params) => qs.stringify(params, {indices: false})
    ]
  }

  //axios拦截器
  private interceptors() {
    // 请求发送之前拦截
    this.axiosInstance.interceptors.request.use((config: AxiosRequestConfig) => {
      //这里可以设置头部token携带到后端进行token的验证
      let token = getToken() || '';
      if (token) config.headers!.token = token
      return config
    }, (error) => {
      // 错误抛到业务代码
      error.data = {}
      error.data.msg = '服务器异常，请联系管理员！'
      return error
    })

    /**
     * 请求返回之后拦截
     * res的类型是AxiosResponse<any>
     */
    this.axiosInstance.interceptors.response.use((res: AxiosResponse) => {
      if (res && res.data) {
        const data = res.data as any;
        if (data.code == StatusCode.NoAuth) {
          //清空sessionStorage数据
          sessionStorage.clear();
          //跳到登录
          window.location.href = "/login";
          // return res;
        } else if (data.code == StatusCode.Success || res.config.responseType === "arraybuffer") {
          return res;
        } else {
          ElMessage.error(data.msg || '服务器出错!')
          return res || null // 返回数据
        }
      }

    }, (error) => { // 这里是遇到报错的回调
      console.log('进入错误')
      error.data = {};
      if (error && error.response) {
        switch (error.response.status) {
          case 400:
            error.data.msg = '错误请求';
            ElMessage.error(error.data.msg)
            break
          case 401:
            error.data.msg = '未授权，请重新登录';
            ElMessage.error(error.data.msg)
            break
          case 403:
            error.data.msg = '拒绝访问';
            ElMessage.error(error.data.msg)
            break
          case 404:
            error.data.msg = '请求错误,未找到该资源';
            ElMessage.error(error.data.msg)
            break
          case 405:
            error.data.msg = '请求方法未允许';
            ElMessage.error(error.data.msg)
            break
          case 408:
            error.data.msg = '请求超时';
            ElMessage.error(error.data.msg)
            break
          case 500:
            error.data.msg = '服务器端出错';
            ElMessage.error(error.data.msg)
            break
          case 501:
            error.data.msg = '网络未实现';
            ElMessage.error(error.data.msg)
            break
          case 502:
            error.data.msg = '网络错误';
            ElMessage.error(error.data.msg)
            break
          case 503:
            error.data.msg = '服务不可用';
            ElMessage.error(error.data.msg)
            break
          case 504:
            error.data.msg = '网络超时';
            ElMessage.error(error.data.msg)
            break
          case 505:
            error.data.msg = 'http版本不支持该请求';
            ElMessage.error(error.data.msg)
            break
          default:
            error.data.msg = `连接错误${error.response.status}`;
            ElMessage.error(error.data.msg)
        }
      } else {
        error.data.msg = "连接到服务器失败";
        ElMessage.error(error.data.msg)
      }
      return error
    })
  }

  /**
   * http://localhost:8089/api/user/getUserById?userId=10
   * @param url   /api/user/getUserById
   * @param params  {userId:10}
   * @returns
   */
  get<T = any>(url: string, params?: any): Promise<Result<T>> {
    return new Promise((resolve, reject) => {
      this.axiosInstance.get<T>(url, params).then((res) => {
        resolve(res.data as any)
      }).catch((error) => {
        reject(error)
      })
    })
  }

  /**
   * http://localhost:8089/api/user/getUserById/10
   * @param url   /api/user/getUserById
   * @param params  {userId:10}
   * @returns
   */
  getRestApi<T = any>(url: string, params?: any): Promise<Result<T>> {
    return new Promise((resolve, reject) => {
      this.axiosInstance.get<T>(this.getParams(params) ? `${url}/${this.getParams(params)}` : url)
        .then((res) => {
          resolve(res.data as any)
        })
        .catch((error) => {
          reject(error)
        })
    })
  }

  getParams(params: any): string {
    let _params = "";
    if (Object.is(params, undefined)) {
      _params = ''
    } else {
      for (const key in params) {
        if (params.hasOwnProperty(key) && params[key]) {
          _params += `${params[key]}/`
        }
      }
    }
    //去掉参数最后一位/
    if (_params) _params = _params.slice(0, _params.length - 1);
    return _params;
  }

  post<T = any>(url: string, params: any, config: AxiosRequestConfig = {}): Promise<Result<T>> {
    config = Object.assign(this.defaultConfig, config)
    return new Promise((resolve, reject) => {
      this.axiosInstance.post<T>(url, params, config).then((res) => {
        resolve(res.data as any)
      }).catch((error) => {
        reject(error)
      })
    })
  }

  put<T = any>(url: string, params: any, config: AxiosRequestConfig = {}): Promise<Result<T>> {
    config = Object.assign(this.defaultConfig, config)
    return new Promise((resolve, reject) => {
      this.axiosInstance.put<T>(url, params, config).then((res) => {
        resolve(res.data as any)
      }).catch((error) => {
        reject(error)
      })
    })
  }

  delete<T = any>(url: string, params: any): Promise<Result<T>> {
    return new Promise((resolve, reject) => {
      this.axiosInstance.delete<T>(this.getParams(params) ? `${url}/${this.getParams(params)}` : url)
        .then((res) => {
          resolve(res.data as any)
        }).catch((error) => {
        reject(error)
      })
    })
  }

  postAny<T = any>(url: string, params: any, config: AxiosRequestConfig): Promise<T> {
    config = Object.assign(this.defaultConfig, config)
    return new Promise((resolve, reject) => {
      this.axiosInstance.post<T>(url, params, config).then((res) => {
        resolve(res.data as any)
      }).catch((error) => {
        reject(error)
      })
    })
  }

  /**
   * 获取图片（验证码）
   * @param url
   */
  getImage(url: string) {
    return this.axiosInstance.post(url, null, {
      responseType: 'arraybuffer'
    })
  }

  /**
   * 单例模式
   * @private
   */
  private static instance: Request;
  public static getInstance(config: AxiosRequestConfig) {
    if (!Request.instance) {
      Request.instance = new Request(config)
    }
    return Request.instance
  }
}

export default Request;
```

src/utils/auth.ts

```
enum Keys {
  Token = 'token',
  UserId = 'userId',
  ExpireTime = 'expireTime'
}

//存储token到session
export const setToken = (token: string) => {
  sessionStorage.setItem(Keys.Token, token)
}
export const getToken = () => {
  return sessionStorage.getItem(Keys.Token)
}

//存储userId到sessionStorage
export const setUserId = (userId: number) => {
  sessionStorage.setItem(Keys.UserId, JSON.stringify(userId))
}
export const getUserId = () => {
  return sessionStorage.getItem(Keys.UserId)
}

//存储过期时间
export const setExpireTime = (time: number) => {
  sessionStorage.setItem(Keys.ExpireTime, JSON.stringify(time))
}
export const getExpireTime = () => {
  return sessionStorage.getItem(Keys.ExpireTime)
}

//session清空
export const cleanSession = () => {
  sessionStorage.clear()
}
```

2.src/http/index.ts

```
// import Request from "./ajax";
// const http = new request({
//     baseURL:'http://42.193.158.170:8098',
//     timeout: 10000
// })
// export default http;

// 单例模式
import Request from "./ajax";
const http = Request.getInstance({
  timeout: 10000
})
export default http;
```

### 第17讲 登录页静态页面

src/view/login/Login.vue

```
<template>
  <div class="logincontainer">
    <el-form
        class="loginForm"
        :model="loginModel"
        ref="loginFormRef"
        :rules="rules"
        :inline="false"
    >
      <el-form-item>
        <div class="loginTitle">系统登录</div>
      </el-form-item>
      <el-form-item prop='username'>
        <el-input placeholder="请输入账户" v-model="loginModel.username"></el-input>
      </el-form-item>
      <el-form-item prop='password'>
        <el-input type='password' placeholder="请输入密码" v-model="loginModel.password"></el-input>
      </el-form-item>
      <el-form-item prop='code'>
        <el-row :gutter="20">
          <el-col :span="16">
            <el-input placeholder="请输入验证码" v-model="loginModel.code"></el-input>
          </el-col>
          <el-col :span="8">
            <el-input placeholder="请输入验证码" v-model="loginModel.code"></el-input>
            <!-- <img :src='imgSrc' @click="getImage"/> -->
          </el-col>
        </el-row>
      </el-form-item>
      <el-form-item class="btnLayout">
        <el-row :gutter="20" class="btnGroup">
          <el-col :span="12">
            <el-button class="mybtn" @click="login" type="primary">登录</el-button>
          </el-col>
          <el-col :span="12">
            <el-button class="mybtn">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>
<script setup lang='ts'>
import {ref, reactive} from 'vue'

let loginModel = reactive({
  username: '',
  password: '',
  code: ''
})

let imgSrc = ref('')
let rules = ref([])
let getImage = () => {
}
let login = () => {
}

// // 组合API
// import useImage from '@/composables/login/useImage';
// import useBaseLogin from '@/composables/login/useBaseLogin';
// import useLogin from '@/composables/login/useLogin';
// //基础数据
// const {loginModel, rules, loginFormRef} = useBaseLogin();

// //验证码
// const {imgSrc, getImage} = useImage();

// //登录
// const {login} = useLogin(loginModel);


</script>
<style scoped lang='scss'>
.logincontainer {
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;

  .loginForm {
    height: 320px;
    width: 400px;
    border-radius: 10px;
    padding: 20px 35px;
    box-shadow: 0 0 25px #cac6c6;

    .loginTitle {
      font-size: 24px;
      font-weight: 600;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .mybtn {
      width: 100%;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }

    .el-form-item {
      .el-form-item__content {
        justify-content: center;

        .el-input {
          :deep(.el-input__inner) {
            height: 40px;
          }
        }

        .el-button {
          height: 40px;
        }
      }

      &.btnLayout {
        margin-top: 10px;

        .btnGroup {
          width: 100%;
          margin-left: 0 !important;
          margin-right: 0 !important;

          .el-col:nth-child(1) {
            padding-left: 0 !important;
          }
          .el-col:nth-child(2) {
            padding-right: 0 !important;
          }
        }
      }
    }
  }
}

</style>
```

src/router/index.ts

```
+ {
+     path: '/login',
+     component: () => import('@/views/login/Login.vue'),
+     name: 'login',
+     children: []
+ },
```

### 第18讲 做一些优化(自己的)

1.多环境打包

/.env.test

```
# 必须VITE开头
VITE_RUNNING_ENV = 'test'
VITE_RUNNING_DESC = '测试环境打包'
```

/package.json

```
"dev": "vite --mode dev",
"build:test": "vite build --mode test",
"build:prod": "vite build --mode prod",
```

2.统一管理多url

src/services/serviceHelper.ts

```
let dev = {
  normalURL: 'http://42.193.158.170:8098',
  iotURL: 'http://42.193.158.170:8098/iot_test',
  woURL: 'http://42.193.158.170:8098/wo_server_test',
  authURL: 'http://42.193.158.170:8098/psgs_auth_server_test',
  safeProdURL: 'http://42.193.158.170:8098/safeprod_test',
  pumpUrl: 'http://42.193.158.170:8098/gwxj_test',
  aeURL: 'http://42.193.158.170:8098/testPsgsDuAe'
}

let test = {
  normalURL: 'http://42.193.158.170:8098',
  iotURL: 'http://42.193.158.170:8098/iot_test',
  woURL: 'http://42.193.158.170:8098/wo_server_test',
  authURL: 'http://42.193.158.170:8098/psgs_auth_server_test',
  safeProdURL: 'http://42.193.158.170:8098/safeprod_test',
  pumpUrl: 'http://42.193.158.170:8098/gwxj_test',
  aeURL: 'http://42.193.158.170:8098/testPsgsDuAe'
}

let prod = {
  normalURL: 'http://42.193.158.170:8098',
  iotURL: 'http://42.193.158.170:8098/iot_test',
  woURL: 'http://42.193.158.170:8098/wo_server_test',
  authURL: 'http://42.193.158.170:8098/psgs_auth_server_test',
  safeProdURL: 'http://42.193.158.170:8098/safeprod_test',
  pumpUrl: 'http://42.193.158.170:8098/gwxj_test',
  aeURL: 'http://42.193.158.170:8098/testPsgsDuAe'
}

// @ts-ignore
let RUNNING_ENV = { dev, test, prod }[import.meta.env.VITE_RUNNING_ENV]

export const normalURL =  RUNNING_ENV.normalURL
export const iotURL =  RUNNING_ENV.iotURL
export const woURL =  RUNNING_ENV.woURL
export const authURL =  RUNNING_ENV.authURL
export const safeProdURL =  RUNNING_ENV.safeProdURL
export const pumpUrl =  RUNNING_ENV.pumpUrl
export const aeURL =  RUNNING_ENV.aeURL
```

src/http/index.ts

```
// 单例模式
import Request from "./ajax";
const http = Request.getInstance({
-  baseURL: 'http://42.193.158.170:8098',
   timeout: 10000
})
export default http;
```

src/services/userService (使用请求)

```
import http from '@/http'
import {normalURL} from '@/services/serviceHelper'
import {LoginResult, UserInfo} from './userModel'

const Api = {
  getImg: normalURL + '/api/sysUser/image',
  login: normalURL + '/api/user/login',
  getUserInfo: normalURL + '/api/sysUser/getInfo',
}

//获取验证码
export async function getImageApi() {
  return await http.getImage(Api.getImg)
}
//登录
export async function loginApi(params: any) {
  return await http.postAny<LoginResult>(Api.login, params, {
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
  })
}
//获取用户信息
export const getUserInfoApi = async () => {
  return await http.get<UserInfo>(Api.getUserInfo)
}

// enum Api {
//   getImg = '/api/sysUser/image'
// }
//获取验证码
// export async function getImageApi() {
//   return await http.getImage(api.getImg)
// }
```

### 第19讲 获取验证码

src/composables/login/useImage.ts (组合式API, 其实类似Mixin)

```
import {ref, onMounted} from 'vue'
import {getImageApi} from '@/api/user/user'

export default function useImage() {
  let imgSrc = ref('')

  const getImage = () => {
    getImageApi()
      .then((res) => {
        // console.log(res)
        return 'data:image/png;base64,' + btoa(
          new Uint8Array(res.data as any).reduce((data, byte) => data + String.fromCharCode(byte), '')
        )
      })
      .then((data) => {
        imgSrc.value = data
      })
  }

  onMounted(() => {
    getImage()
  })

  return {
    imgSrc,
    getImage
  }
}
```

src/view/login/Login.vue

```
- let imgSrc = ref('')
- let getImage = () => {}

+ // 组合API
+ import useImage from '@/composables/login/useImage';
+ //验证码
+ const {imgSrc, getImage} = useImage();
```

### 第20讲 登录

src/composables/login/useLogin.ts (组合式API, 其实类似Mixin)

```
import {ref, reactive} from 'vue'
import { ElForm } from "element-plus";

export default function useLogin() {
  // 表单绑定数据
  let loginModel = reactive({
    username: 'admin',
    password: '1234',
    code: ''
  })
  //表单验证规则
  let rules = reactive({
    username: [{
      required: true,
      trigger: 'change',
      message: '请填写登录账户'
    }],
    password: [{
      required: true,
      trigger: 'change',
      message: '请填写登录密码'
    }],
    code: [{
      required: true,
      trigger: 'change',
      message: '请填写验证码'
    }]
  })
  // 表单的ref属性
  // 自定义组件获取ref的固定写法, ElForm就是组件名
  const loginFormRef = ref<InstanceType<typeof ElForm>>();

  return {
    loginModel,
    rules,
    loginFormRef
  }
}

```

src/composables/login/useLogin2.ts (组合式API, 其实类似Mixin)

```
import {getCurrentInstance} from "vue";
import {loginApi} from '@/services/userService'

export default function useLogin2(loginModel: any) {
  const {proxy} = getCurrentInstance() as any;

  let login = () => {
    proxy.$refs.loginFormRef.validate(async (valid: boolean) => {
      if (valid) {
        loginApi(loginModel).then((res) => {
          console.log(res)
        })
      }
    })
  }

  return {
    login
  }
}

// export default function useLogin(loginModel:LoginParm) {
//   const router = useRouter();
//
//   const store = useStore();
//
//   const { proxy } = getCurrentInstance() as any;
//
//   //登录提交
//   const login = async () => {
//     //表单验证
//     console.log(proxy)
//     console.log(loginModel)
//     proxy.$refs.loginFormRef.validate(async(valid: boolean) => {
//       if (valid) {
//         store.dispatch('user/login',loginModel).then(res =>{
//           console.log('登录成功')
//           // console.log(res)
//           // store.dispatch('user/getInfo')
//           if(res.code == 200){
//             //跳转到首页
//             router.push({path:'/'})
//           }
//         })
//       }
//     })
//   }
//   return {
//     login
//   }
// }
```

src/view/login/Login.vue

```
<el-form
    class="loginForm"
    :model="loginModel"
    :rules="rules"
    :inline="false"
+    ref="loginFormRef"
>


+ <script setup lang='ts'>
+ // import {ref, reactive} from 'vue'
+ // let loginModel = reactive({
+ //   username: '',
+ //   password: '',
+ //   code: ''
+ // })
+ // let rules = ref([])
+ // let imgSrc = ref('')
+ // let getImage = () => {}
+ // let login = () => {}
+ 
+ // 组合API
+ import useImage from '@/composables/login/useImage';
+ import useLogin from '@/composables/login/useLogin';
+ import useLogin2 from '@/composables/login/useLogin2';
+ //基础数据
+ const {loginModel, rules, loginFormRef} = useLogin();
+ 
+ //验证码
+ const {imgSrc, getImage} = useImage();
+ 
+ //登录
+ const {login} = useLogin2(loginModel);
+ </script>
```


### 第21讲 登录接口优化

把登录接口放到vuex的action里, token放到state里

1.新建vuex模块 src/store/modules/user.ts

- 把请求放action
    - 登录成功后
    - 把token、userId放state和mutations
    - 把token、userId放sessionStorage

```
//定义state
import {loginApi} from "@/services/userService";
import {ActionContext} from "vuex"
import {RootState} from "@/store";
import {setUserId, setToken, setExpireTime} from "@/utils/auth";

export type UserState = {
  token: string,
  userId: string
}
export const state: UserState = {
  token: '',
  userId: '',
}

//定义actions
export const actions = {
  login({commit}: ActionContext<UserState, RootState>, loginModel: any) {
    return new Promise((resolve, reject) => {
      loginApi(loginModel).then((res) => {
        if (res.code == 200) {
          commit('setToken', res.token)
          commit('setUserId', res.id)
          //存到cookies ==> sessioStorage
          setUserId(res.id)
          setToken(res.token)
          setExpireTime(res.expireTime)
        }
        resolve(res)
      }).catch((err) => {
        reject(err)
      })
    })
  }
}

//定义mutations
export const mutations = {
  setToken(state: UserState, token: string) {
    state.token = token
  },
  setUserId(state: UserState, userId: string) {
    state.userId = userId
  }
}

//定义getters
export const getters = {}

export default {
  namespaced: true,
  state,
  mutations,
  actions,
  getters
}
```

2.src/store/index.ts（引入）

```
+ import user, {UserState} from '../store/modules/user'

//是一种规范
export type RootState = {
  tabs: TabState,
  menu: MenuState,
+  user: UserState,
}
//导入所有的模块
export const modules = {
  tabs,
  menu,
+  user
}
```

3.登录页面调用vuex的user的登录

src/composables/useLogin2.ts

```
export default function useLogin2(loginModel: any) {
  const {proxy} = getCurrentInstance() as any;
  const store = useStore()
  const router = useRouter()

  let login = () => {
    proxy.$refs.loginFormRef.validate(async (valid: boolean) => {
      if (valid) {
        store.dispatch('user/login', loginModel).then((res: any) => {
          if(res.code === 200) {
            router.push({path: '/'})
          }
        })
      }
    })
  }

  return {
    login
  }
}
```

### 第22讲 获取用户权限信息

1. src/composables/login/useLogin2.ts

```
export default function useLogin2(loginModel: any) {
  const {proxy} = getCurrentInstance() as any;
  const store = useStore()
  const router = useRouter()

  let login = () => {
    proxy.$refs.loginFormRef.validate(async (valid: boolean) => {
      if (valid) {
        store.dispatch('user/login', loginModel).then((res) => {
          if(res.code === 200) {
            // 请求用户权限
+            store.dispatch('user/getUserInfo')
            router.push({path: '/'})
          }
        })
      }
    })
  }

  return {
    login
  }
}
```

2. src/store/modules/user.ts

```
export const actions = {
+  getUserInfo({commit}: ActionContext<UserState, RootState>) {
+    return new Promise((resolve, reject) => {
+      getUserInfoApi().then((res) => {
+        if (res.code == 200) {
+          commit('setRoles', res.data.roles)
+        }
+        resolve(res)
+      }).catch((err) => {
+        reject(err)
+      })
+    })
+  }
}

//定义mutations
export const mutations = {
+  setRoles(state: UserState, roles: string[]) {
+    state.permissions = roles;
+  }
}

//定义getters
export const getters = {
+  //获取用户的权限字段
+  getPermissions(state: UserState) {
+    return state.permissions
+  }
}
```

3. src/services/userService.ts

```
import http from '@/http'
import {normalURL} from '@/services/serviceHelper'
+ import {LoginResult, UserInfo} from './userModel'

const Api = {
  getImg: normalURL + '/api/sysUser/image',
  login: normalURL + '/api/user/login',
+  getUserInfo: normalURL + '/api/sysUser/getInfo',
}

+ //获取用户信息
+ export const getUserInfoApi = async () => {
+   return await http.get<UserInfo>(Api.getUserInfo)
+ }
```

4. src/services/userModel.ts

```
/**
 * 登录请求参数类型
 */
export interface LoginParm {
  username: string;
  password: string;
  code: string;
}

/**
 * 登录成功返回值类型
 */
export interface LoginResult {
  id: number;
  token: string;
  code: number;
  expireTime: number;
}

/**
 * 用户信息
 */
export interface UserInfo {
  avatar: string;
  id: string;
  introduction: string;
  name: string;
  roles: Array<string>
}

/**
 * 用户列表查询参数
 */
export interface UserListParm {
  deptId: string | number;
  loginName: string;
  currentPage: number;
  pageSize: number;
  total: number;
}

/**
 * 表单提交的参数
 */
export interface AddUserModel {
  type: string; //判断新增还是编辑
  id: string | number;
  deptId: string | number;
  deptName: string;
  loginName: string;
  mobile: string;
  nickName: string;
  email: string;
  username: string;
  password: string;
  sex: string;
}

/**
 * 分配角色列表参数
 */
export interface AssignRoleListParm {
  currentPage: number,
  pageSize: number,
  userId: string | number,
  total: number,
}

export interface SelectRoleParm {
  roleId: string | number;
  userId: string | number;
}
```

### 第23讲 动态菜单（动态路由）

vue2: https://www.jianshu.com/p/1a59ee7dde22  
vue3:

1. 添加接口请求

src/services/menuService.ts

```
import http from '@/http'
import {normalURL} from '@/services/serviceHelper'
import {LoginResult, UserInfo} from './userModel'

const Api = {
  getMenuList: normalURL + '/api/sysUser/getMenuList',
}

//获取菜单
export const getMenuListApi = async () => {
  return await http.get(Api.getMenuList)
}
```

2. store请求、存储

src/store/modules/menu.ts

```
+ import {RouteRecordRaw} from "vue-router";
+ import {ActionContext} from "vuex";
+ import {RootState} from "@/store";
+ import {getMenuListApi} from "@/services/menuService";
+ import Layout from '@/layout/index.vue'
+ const modules = import.meta.glob('../../views/**/*.vue')
+ /**
+  * 获取全部组件, 返回值如下
+  * {
+  *   '../../views/system/user/UserList.vue': () => import("/src/views/system/user/UserList.vue")
+  * }
+  */

//定义state
export type MenuState = {
  count: number,
  collapse: boolean,
+  menuList: any
}
export const state: MenuState = {
  count: 0,
  collapse: false,
+  menuList: [
+    {
+      path: '/homePage',
+      component: "Layout",
+      meta: {
+        title: "首页",
+        icon: "HomeFilled",
+        roles: ["sys:manage"]
+      },
+      children: []
+    }
+  ]
}

//定义actions
export const actions = {
+  getMenuList({commit}: ActionContext<MenuState, RootState>, router: any) {
+    return new Promise((resolve, reject) => {
+      getMenuListApi().then(res => {
+        let accessedRoutes;
+        if (res.code == 200) {
+          // 动态生成路由
+          accessedRoutes = filterAsyncRoutes(res.data, router);
+          // 设置到menuList
+          commit('setMenuList', accessedRoutes)
+        }
+        resolve(accessedRoutes);
+      }).catch(error => {
+        reject(error)
+      })
+    })
+  }
}

//定义mutations
export const mutations = {
  setCount(state: MenuState, count: number) {
    state.count = count;
  },
  setCollapse: (state: MenuState, collapse: boolean) => {
    state.collapse = collapse;
  },
+  setMenuList: (state: MenuState, menuList: Array<RouteRecordRaw>) => {
+    state.menuList = state.menuList.concat(menuList)
+  }
}

//定义getters
export const getters = {
  getCount(state: MenuState) {
    return state.count;
  },
  getCollapse: (state: MenuState) => {
    return state.collapse;
  },
+  getMenuList: (state: MenuState) => {
+    return state.menuList
+  }
}

+ export function filterAsyncRoutes(routes: RouteRecordRaw[], router: any) {
+   const res: Array<RouteRecordRaw> = [];
+   routes.forEach((route: any) => {
+     const tmp = {...route}
+     const {component} = tmp
+     if (component) tmp.component = component === 'Layout' ? Layout : modules[`../../views${component}.vue`]
+     //递归
+     if (tmp.children) tmp.children = filterAsyncRoutes(tmp.children, router)
+     router.addRoute(tmp)
+     res.push(tmp)
+   })
+   return res;
+ }

export default {
  namespaced: true,
  state,
  mutations,
  actions,
  getters
}
```

3. 接口返回的url和当前项目的文件夹、文件命名有些不同,酌情改一下

4.menuBar改用store的动态路由

src/layout/menu/MenuBar.vue

```
//菜单数据
const menuList = computed(() =>{
  return store.getters['menu/getMenuList']
})
```
替换掉原来的mock数据

5. /main.ts

利用路由守卫做权限验证:
前提: 已经使用动态路由
- 没有token
    - 1.属于白名单, 跳转白名单
    - 2.不属于白名单, 跳转login
- 有token
    - 1.跳转['/'], 允许
    - 2.有没用户权限信息(登录过会存储在store中)
        - 1.有, 在系统内随便跳转
        - 2.没, 拿token获取用户信息和用户菜单, 然后随便跳

```
//权限验证处理:全集守卫路由实现
//白名单
const whiteList = ['/login'];
router.beforeEach(async (to, from, next) => {
  let token = getToken();
  if (token) {
    if (['/'].includes(to.path)) {
      next({path: '/'})
    } else {
      let hasRoles = store.state.user.permissions && store.state.user.permissions.length
      if (hasRoles) {
        next()
      } else {
        try {
          //vuex中不存在权限，从服务器获取
          await store.dispatch('user/getUserInfo')
          //获取菜单、动态生成路由
          await store.dispatch('menu/getMenuList', router)
          //确保动态添加的路由已经被完全加载上去
          next({...to, replace: true})
        } catch (error) {
          //重置token
          cleanSession();
          //跳到登录
          next({path: '/login'})
        }
      }
    }
  } else {
    whiteList.includes(to.path) ? next() : next({path: '/login'})
  }
})
```

6.修改路由

src/router/index.ts (用下面的替代之前的)

```
export const routes: Array<RouteRecordRaw> = [
  {
    path: '/login',
    component: () => import('@/views/login/Login.vue'),
    name: 'login',
    children: []
  },
  {
    path: '/',
    component: Layout,
    name: 'Layout',
    redirect: '/homepage',
    children: [
      {
        path: '/homepage',
        component: () => import('@/layout/homepage/Index.vue'),
        name: 'homepage',
        meta: {
          title: '首页',
          icon: '#icondashboard'
        }
      }
    ]
  }
]
```

7. 修补小bug
- 重复发送getUserInfo, 注释掉useLogin2里的
- MenuItem.vue的图标, 和视频用的element-plus版本不一致, 暂时不修复

### 第24讲 系统管理->机构管理->获取列表

1.定义API和Model  
src/services/departmentService.ts
```
import http from '@/http'
import {normalURL} from '@/services/serviceHelper'
import {IListParams} from '@/services/departmentModel'

const Api = {
  getDepartmentList: normalURL + '/api/department/list',
}

// 获取列表
export async function getDepartmentListApi(params: IListParams) {
  return await http.get(Api.getDepartmentList, params)
}
```

src/services/departmentModel.ts
```
export interface IListParams {
  searchName: string;
}

export interface ITableData {
  list: any;
}

//部门表格每行数据的格式
export interface DeptModel {
  id: number;
  pid: number;
  likeId: number;
  parentName: string;
  manager: string;
  name: string;
  deptCode: string;
  deptAddress: string;
  deptPhone: string;
  orderNum: number;
  open: boolean;
  children: Array<DeptModel>
}

//表单提交的数据类型
export interface AddDeptModel {
  type: string;
  id: string | number;
  pid: string | number;
  parentName: string;
  manager: string;
  deptAddress: string;
  deptPhone: string;
  name: string;
  deptCode: string;
  orderNum: string;
}

//上级部门树选中的数据
export interface SelectNode {
  id: string | number;
  name: string;
}


```

2.定义组件组合式API  
src/composables/department/useDepartmentTable.ts

```
import {IListParams, ITableData} from '@/services/departmentModel'
import {getDepartmentListApi} from '@/services/departmentService'
import {reactive, onMounted} from "vue";

export default function useDepartmentTable() {
  // 搜索栏
  let searchForm = reactive<IListParams>({
    searchName: ''
  })
  // 表格数据
  let tableData = reactive<ITableData>({
    list: []
  })

  // 获取表格数据
  let getTableData = () => {
    getDepartmentListApi(searchForm).then((res) => {
      if (res && res.code === 200) {
        tableData.list = res.data
      }
    })
  }

  onMounted(() => {
    getTableData()
  })

  return {
    searchForm,
    tableData,
    getTableData,
  }
}
```

2. 定义组件组合式API_基础数据  
src/composables/department/useBaseModel.ts
   
```
import { reactive } from "vue";

export default function useBaseModel() {
  //表单验证规则
  const rules = reactive({})

  return {
    rules
  }
}
```

3.组件使用组合式API  
src/views/system/department/department.vue
```
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="searchForm" :rules="rules" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input size="large" v-model="searchForm.searchName" placeholder="请输入部门名称"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button size="large" :icon="Search">查询</el-button>
        <!-- <el-button type="primary" :icon='Plus'>新增</el-button> -->
        <el-button size="large" type="primary" :icon="Plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :data="tableData.list"
      style="width: 100%"
      row-key="id"
      default-expand-all
      size="medium"
      border
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="name" label="部门名称" />
      <el-table-column prop="deptCode" label="部门编码" />
      <el-table-column prop="deptPhone" label="部门电话" />
      <el-table-column width="200" align="center" label="操作">
        <template #default="scope">
          <el-button size="mini" type="success" :icon="Edit">编辑</el-button>
          <el-button size="mini" type="danger" :icon="Close">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-main>
</template>
<script lang="ts" setup>
import useBaseModel from '@/composables/department/useBaseModel'
import useDepartmentTable from '@/composables/department/useDepartmentTable';
import {Edit,Close,Plus,Search} from '@element-plus/icons-vue'

let { rules } = useBaseModel()
let { searchForm, tableData, getTableData } = useDepartmentTable()

</script>

<style lang="scss" scoped>
</style>
```

### 第25讲 弹窗封装和测试

src/components/SysDialog.vue（具名插槽和作用域插槽）
```
<!-- 此处注意，使用 v-model="visible"绑定的形式
上线会报错

修改为如下方式
:model-value="visible"
 -->
<template>
  <el-dialog
    :title='title'
    :model-value="visible"
    :before-close="onClose"
    append-to-body
    :width="width + 'px'"
  >
    <div class="container" :style="{height:height + 'px'}">
      <slot name="content"></slot>
    </div>
    <template #footer>
            <span class="dialog-footer">
                <el-button type='danger' @click="onClose">取消</el-button>
                <el-button type="primary" @click="onConfirm">确定</el-button>
            </span>
    </template>
  </el-dialog>
</template>
<script setup lang='ts'>
import {ref, reactive} from 'vue'

const props = defineProps({
  title: {//弹框标题
    type: String,
    default: '标题'
  },
  visible: { //控制弹框的展示和影藏
    type: Boolean,
    default: false
  },
  width: {
    type: Number,
    default: 600
  },
  height: {
    type: Number,
    default: 250
  }
})
// 定义emit
const emit = defineEmits(['onClose', 'onConfirm'])
// 定义弹框的关闭
const onClose = () => {
  emit('onClose')
}
// 定义弹框的确定
const onConfirm = () => {
  emit('onConfirm')
}
</script>
<style lang="scss" scope>
.container {
  overflow-x: initial;
  overflow-y: auto;
}

.el-dialog {
  border-top-left-radius: 7px !important;
  border-top-right-radius: 7px !important;

  .el-dialog__header {
    border-top-left-radius: 7px !important;
    border-top-right-radius: 7px !important;
    background-color: #1890ff !important;

    .el-dialog__title {
      color: #fff;
      font-size: 16px;
      font-weight: 600;
    }

    .el-dialog__close {
      color: #fff;
    }
  }

  .el-dialog__body {
    padding: 10px;
  }

  .el-dialog__footer {
    border-top: 1px solid #e8eaec !important;
    padding: 10px;
  }
}
</style>
```

src/components/TestDialog.vue
```
<template>
  <div>
      <el-button type="primary" size="default" @click="addBtn">新增</el-button>
      
  </div>
  <SysDialog
  :title="dialog.title"
  :visible="dialog.visible"
  :height="dialog.height"
  :width="dialog.width"
  @onClose='onClose'
  @onConfirm='onConfirm'
  >
      <template v-slot:content>
          弹框内容
      </template>
  </SysDialog>
</template>
<script setup lang='ts'>
import { ref,reactive} from 'vue'
//引入组件
import SysDialog from './SysDialog.vue';
//定义弹框属性
const dialog = reactive({
    title:'新增',
    visible:false,
    height:280,
    width:630
})
//按钮点击事件
const addBtn = () =>{
    //visible为true的时候，弹框显示
    dialog.visible = true;
}
//关闭
const onClose = () =>{
    dialog.visible = false;
}
//确定
const onConfirm = () =>{
    dialog.visible = false
}
</script>
<style scoped lang='scss'>
</style>
```

src/router/index.ts
```
{
    path: '/test',
    name: 'test',
    component: () => import('@/components/TestDialog.vue'),
}
```

### 第26讲 系统管理->机构管理->新增

- 进度: 新增的静态页面、选择`上级部门`的接口页面

1.写新增页面

src/views/system/department/AddAndEdit.vue

```
<template>
  <SysDialog
    :title="dialog.title"
    :visible="dialog.visible"
    :width="dialog.width"
    :height="dialog.height"
    @onClose="onClose"
    @onConfirm="confirm"
  >
    <template v-slot:content>
      <el-form
        :model="dialogModel"
        ref="addDeptForm"
        :rules="rules"
        label-width="80px"
        size="small"
      >
        <el-row>
          <el-col :span="12">
            <el-form-item prop="parentName" label="上级部门">
              <el-input type="hidden" v-model="dialogModel.pid"></el-input>
              <el-input @click="selectTree" v-model="dialogModel.parentName"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item prop="name" label="部门名称">
              <el-input v-model="dialogModel.name"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="12">
            <el-form-item prop="deptCode" label="部门编码">
              <el-input v-model="dialogModel.deptCode"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item prop="deptPhone" label="部门电话">
              <el-input v-model="dialogModel.deptPhone"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="12">
            <el-form-item prop="manager" label="部门经理">
              <el-input v-model="dialogModel.manager"></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item prop="deptAddress" label="部门地址">
              <el-input v-model="dialogModel.deptAddress"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="12">
            <el-form-item prop="orderNum" label="部门序号">
              <el-input v-model="dialogModel.orderNum"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
    </template>
  </SysDialog>

  <!-- 上级部门弹框 -->
   <deparentmentSelectTree ref="selectTreeRef" @select="select"></deparentmentSelectTree>
</template>
<script setup lang='ts'>
import SysDialog from '@/components/SysDialog.vue'
import useDialog from '@/hooks/useDialog'
import useBaseModel from '@/composables/department/useBaseModel'
import { EditType, Title } from '@/type/BaseEnum'
import { ref } from 'vue'
import { ElForm } from 'element-plus'
import {DeptModel, SelectNode} from '@/services/departmentModel'
import deparentmentSelectTree from './deparentmentSelectTree.vue'
import useSelectTree from '@/composables/department/useSelectTree'

// import useInstance from '@/hooks/useInstance'
//全局挂载global
// const { global } = useInstance();

//弹框属性
const { dialog, onShow, onClose } = useDialog();
//基础数据
const { dialogModel, rules } = useBaseModel();
//表单的ref属性
const addDeptForm = ref<InstanceType<typeof ElForm>>();
//定义事件
const emit = defineEmits(['save'])
//弹框的确定,把表单的值，返回给父组件
const confirm = () => {
  addDeptForm.value?.validate(valid => {
    if (valid) {
      emit('save', dialogModel)
      onClose();
    }
  })
}

//显示弹框
const show = (type: string, row?: DeptModel) => {
  dialog.width = 650;
  dialog.height = 250;
  type == EditType.ADD ? dialog.title = Title.ADD : dialog.title = Title.EDIT
  onShow();
  // //清空表单
  // global.$resetForm(addDeptForm.value, dialogModel);
  // if (EditType.EDIT === type) {
  //   //把要编辑的数据，放到表单绑定的model里面
  //   global.$objCoppy(row, dialogModel)
  // }
  // //设置编辑属性
  // dialogModel.type = type;
}

// 父组件调用ref的时候使用
defineExpose({
  show
})

// 调用子组件deparentmentSelectTree.vue
const { selectTreeRef, selectTree } = useSelectTree();
const select = (node: SelectNode) => {
  dialogModel.pid = node.id;
  dialogModel.parentName = node.name
}
</script>
<style scoped lang='scss'>
</style>
```


2.新增页面-组合API

src/composables/department/useBaseModel.ts

```
import {reactive} from "vue";
import {AddDeptModel} from "@/services/departmentModel";

export default function useBaseModel() {
  //表单验证
  const rules = reactive({
    parentName: [{
      required: true,
      message: '请选择上级部门',
      trigger: 'change',
    }],
    name: [{
      required: true,
      message: '请填写部门名称',
      trigger: 'change',
    }]
  })

  //表单数据
  const dialogModel = reactive<AddDeptModel>({
    type: "",
    id: "",
    pid: "",
    parentName: "",
    manager: "",
    deptAddress: "",
    deptPhone: "",
    name: "",
    deptCode: "",
    orderNum: ""
  })

  return {
    rules,
    dialogModel
  }
}
```

3.相关文件

src/type/BaseEnum

```
export enum EditType {
  ADD = '0', //代表新增
  EDIT = '1' //代表编辑
}

//定义弹框的标题
export enum Title {
  ADD = '新增',
  EDIT = '编辑'
}

```

src/services/departmentModel.ts（已经是全的）

src/composables/department/useSelectTree

```
import {ref} from 'vue'

export default function useSelectTree() {
  //parent组件的ref属性
  const selectTreeRef = ref<{ show: () => void }>()

  //选择上级部门
  const selectTree = () => {
    selectTreeRef.value?.show();
  }
  return {
    selectTreeRef,
    selectTree
  }
}
```

4.写部门选择树页面

src/views/system/department/deparentmentSelectTree.vue

```
<template>
  <SysDialog
    :title="dialog.title"
    :width="dialog.width"
    :height="dialog.height"
    :visible="dialog.visible"
    @onClose="onClose"
    @onConfirm="confirm"
  >
    <template v-slot:content>
      <el-tree
        ref="parentTree"
        :data="treeData.data"
        node-key="id"
        :props="defaultProps"
        default-expand-all
        :highlight-current="true"
        :expand-on-click-node="false"
        @node-click="handleNodeClick"
      >
        <template #default="{ node, data }">
          <div class="custom-tree-container">
            <!-- 长度为0说明没有下级 -->
            <span v-if="data.children.length == 0">
                            <DocumentRemove
                              style="width: 1.3em; height: 1.3em; margin-right: 5px;color: #8c8c8c;"></DocumentRemove>
                        </span>
            <!-- 点击展开和关闭 -->
            <span v-else @click.stop="openBtn(data)">
                            <component style="width: 1.1em; height: 1.1em; margin-right: 5px;color: #8c8c8c;"
                                       :is="data.open ? Plus : Minus"/>
                        </span>
            <span>{{ node.label }}</span>
          </div>
        </template>
      </el-tree>
    </template>
  </SysDialog>
</template>
<script setup lang='ts'>
import {DocumentRemove, Plus, Minus} from '@element-plus/icons-vue'
import SysDialog from '@/components/SysDialog.vue';
import useDialog from '@/hooks/useDialog';
import useDeparentmentSelectTree from '@/composables/department/useDeparentmentSelectTree';

//弹框属性
const {dialog, onClose, onShow} = useDialog()
//树相关数据
const {parentTree, treeData, defaultProps, handleNodeClick, openBtn, selectNode, getTreeData} = useDeparentmentSelectTree();

//供父组件调用，显示弹框
const show = async () => {
  //获取树的数据
  await getTreeData();
  dialog.title = '选择上级部门'
  dialog.height = 420;
  dialog.width = 300;
  onShow();
}
//把方法暴露出去
defineExpose({
  show
})

//子组件传值给父组件
const emit = defineEmits(['select'])
//弹框确定事件
const confirm = () => {
  emit('select', selectNode)
  onClose();
}
</script>

<style lang="scss">
.el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }

  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }

  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }

  .el-tree > .el-tree-node:before {
    border-left: none;
  }

  .el-tree > .el-tree-node:after {
    border-top: none;
  }

  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }

  .tree :first-child .el-tree-node:before {
    border-left: none;
  }

  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }

  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }

  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }

  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }

  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}

//去掉最上级的before  after 即是去电最上层的连接线
.el-tree > div {
  &::before {
    display: none;
  }

  &::after {
    display: none;
  }
}
</style>
```

5.部门选择树页面-组合式API

src/composables/department/useDeparentmentSelectTree.ts

```
import {reactive, ref} from 'vue'
import {ElTree} from 'element-plus';
import {DeptModel, SelectNode} from "@/services/departmentModel";
import {getDeptParentApi} from "@/services/departmentService";

export default function useSelectTree() {
  //树的ref
  const parentTree = ref<InstanceType<typeof ElTree>>();
  //树的数据
  const treeData = reactive({
    data: []
  })
  //树的属性
  const defaultProps = reactive({
    children: 'children', //设置树的children
    label: 'name', //设置树的名字属性字段
  })
  //树的点击事件
  const handleNodeClick = (data: DeptModel) => {
    selectNode.id = data.id;
    selectNode.name = data.name
  }
  //树的打开事件
  const openBtn = (data: DeptModel) => {
    //设置展开或者关闭
    data.open = !data.open;
    if (parentTree.value) {
      parentTree.value.store.nodesMap[data.id].expanded = !data.open;
    }
  }
  //选中的数据
  const selectNode = reactive<SelectNode>({
    id: '',
    name: ''
  })
  //获取树的数据
  const getTreeData = async () => {
    getDeptParentApi().then((res) => {
      if (res && res.code == 200) {
        treeData.data = res.data;
      }
    })
  }

  return {
    treeData,
    defaultProps,
    handleNodeClick,
    getTreeData,
    openBtn,
    parentTree,
    selectNode
  }
}
```

5.部门选择树页面-API请求

src/services/departmentService.ts

```
import http from '@/http'
import {normalURL} from '@/services/serviceHelper'
import {AddDeptModel, IListParams} from '@/services/departmentModel'

const Api = {
  getDepartmentList: normalURL + '/api/department/list',
  getParent: normalURL + '/api/department/parent',
  add: normalURL + '/api/department',
  edit: normalURL + '/api/department',
  delete: normalURL + '/api/department'
}

// 获取列表
export async function getDepartmentListApi(params: IListParams) {
  return await http.get(Api.getDepartmentList, params)
}

//查询上级部门树
export const getDeptParentApi = async () => {
  return await http.get(Api.getParent)
}
//新增
export const addDeptApi = async (params: AddDeptModel) => {
  return await http.post(Api.add, params)
}
//编辑
export const editDeptApi = async (params: AddDeptModel) => {
  return await http.put(Api.edit, params)
}
//删除
export const deleteDeptApi = async (params: any) => {
  return await http.delete(Api.delete, params)
}
```

### 第27讲 axios的安装与使用
### 第28讲 axios的安装与使用
### 第29讲 axios的安装与使用
### 第30讲 axios的安装与使用



### 第99讲 坑

1.vue3+vite 热更新失效

答:发现页面文件名和路由引入大小写不一致。改成一致即可

2.webstorm不持之vue3.2的setup简写

下面写法虽然能运行, 但显示太多波浪线了

```
<script setup lang="ts">
    const count = ref(0)
</script>
```

只能使用之前旧的写法了

```
<script lang="ts">
  import { ref, computed, defineComponent } from 'vue'
  
  export default defineComponent({
    name: 'HelloWorld',
    props: {
        msg: String
    }
    setup(prop) {
      const count = ref(0)
      
      return {
        count
      }
    }
  });
</script>
```

---

`.vue文件`在webstorm中类型检测不友好

- 改用vscode好很多

---

3.ts的配置可以直接拿`vue3-webpack脚手架版本`的

```
{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext",
    "strict": true,
    "jsx": "preserve",
    "importHelpers": true,
    "moduleResolution": "node",
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "sourceMap": true,
    "baseUrl": ".",
    "types": [
      "webpack-env"
    ],
    "paths": {
      "@/*": [
        "src/*"
      ]
    },
    "lib": [
      "esnext",
      "dom",
    ]
  },
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx",
    "src/**/*.vue",
    "tests/**/*.ts",
    "tests/**/*.tsx"
  ],
  "exclude": [
    "node_modules"
  ]
}
```

4.warning: "@charset" must be the first rule in the file

```
// 添加配置即可
https://www.jianshu.com/p/a45f48448be9
```

5.vite 打包大于500kb控制台警告

```
Some chunks are larger than 500 KiB after minification. Consider

打包出来的vendor.js文件太大(第三方依赖的, element-plus/vue/moment)
```

通过CDN+Vite修改打包配置解决

/index.html

```
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
+    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/element-plus/dist/index.css"/>
+    <script src="//cdn.jsdelivr.net/npm/vue@next"></script>
+    <script src="//cdn.jsdelivr.net/npm/element-plus"></script>
    <title>Vite App</title>
  </head>
```

src/main.ts

```
- import 'element-plus/dist/index.css'
```

/vite.config.ts

```
import externalGlobals from "rollup-plugin-external-globals";

export default defineConfig({
  plugins: [vue()],
+  build: {
+    rollupOptions: {
+      external: ["vue", 'element-plus'],
+      plugins: [
+        externalGlobals({
+          vue: "Vue",
+          "element-plus": "ElementPlus",
+        }),
+      ],
+    }
+  },
  server: {
    host: '0.0.0.0',
    port: 8080,
    open: true
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  css: {
    postcss: {
      plugins: [
        {
          postcssPlugin: 'internal:charset-removal',
          AtRule: {
            charset: (atRule) => {
              if (atRule.name === 'charset') {
                atRule.remove();
              }
            }
          }
        }
      ]
    }
  }
})
```

修改后打包出来为200k（修改前700k）






