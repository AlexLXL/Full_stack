{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (v) => typeof v === 'object' && v !== null","export function effect(fn, options = { lazy: false }) {\r\n    let effect = createReactiveEffect(fn, options)\r\n    if (!options.lazy) {\r\n        effect()\r\n    }\r\n    return effect\r\n}\r\n\r\nlet uid = 0\r\nlet activeEffect;\r\nfunction createReactiveEffect(fn, options) {\r\n    const effect = function () {\r\n        activeEffect = effect\r\n        fn()\r\n        activeEffect = null\r\n    }\r\n    effect.id = uid++\r\n    effect._isEffect = true\r\n    effect.raw = fn\r\n    effect.deps = []\r\n    effect.options = options\r\n    return effect\r\n}\r\n\r\n\r\nlet targetMap = new WeakMap()\r\nexport function track(target, type, key) {\r\n    // effect里拿值才有activeEffect\r\n    if (!activeEffect) return\r\n    let depsMap = targetMap.get(target)\r\n    if (!depsMap) {\r\n        targetMap.set(target, depsMap = new Map())\r\n    }\r\n    let dep = depsMap.get(key)\r\n    if (!dep) {\r\n        depsMap.set(key, dep = new Set())\r\n    }\r\n    if (!dep.has(activeEffect)) {\r\n        dep.add(activeEffect)\r\n    }\r\n}\r\n\r\nexport function trigger(target, key, value) {\r\n    let depsMap = targetMap.get(target)\r\n    if (!depsMap) return\r\n    const effects = depsMap.get(key)\r\n    effects.forEach(effect => effect())\r\n}","import get = Reflect.get;\r\nimport {isObject} from \"@vue/shared\";\r\nimport {reactive, readonly} from \"./reactive\";\r\nimport {track, trigger} from \"./effect\";\r\n\r\nconst reactiveGet = createGet(false, false)\r\nconst shallowReactiveGet = createGet(false, true)\r\nconst readonlyGet = createGet(true, false)\r\nconst shallowReadonlyGet = createGet(true, true)\r\nfunction createGet(isReadonly = false, isShallow = false) {\r\n    // target: 目标对象、key: 需要获取的属性、receiver: 目标对象使用的proxy\r\n    return function get(target, key, receiver) {\r\n        let value = Reflect.get(target, key, receiver)\r\n        if (!isReadonly) {\r\n            // --收集依赖--\r\n            track(target, 'get', key)\r\n        }\r\n        if (isShallow) {\r\n            return value\r\n        }\r\n        if (isObject(value)) {\r\n            return isReadonly ? readonly(value) : reactive(value)   // 递归代理[取值的时候才进行,所以性能更优★]\r\n        }\r\n        return value\r\n    }\r\n}\r\n\r\nconst reactiveSet = createSet()\r\nconst shallowReactiveSet = createSet()\r\nconst readonlySet = createSet()\r\nconst shallowReadonlySet = createSet()\r\nfunction createSet() {\r\n    return function set(target, key, value, receiver) {\r\n        let res = Reflect.set(target, key, value, receiver)\r\n        trigger(target, key, value)\r\n        return res\r\n    }\r\n}\r\n\r\nexport const reactiveHandler = {\r\n    get: reactiveGet,\r\n    set: reactiveSet\r\n}\r\nexport const shallowReactiveHandler = {\r\n    get: shallowReactiveGet,\r\n    set: shallowReactiveSet\r\n}\r\nexport const readonlyHandler = {\r\n    get: readonlyGet,\r\n    set: readonlySet\r\n}\r\nexport const shallowReadonlyHandler = {\r\n    get: shallowReadonlyGet,\r\n    set: shallowReadonlySet\r\n}","import {isObject} from \"@vue/shared\";\r\nimport {reactiveHandler, shallowReactiveHandler, readonlyHandler, shallowReadonlyHandler} from \"./baseHandlers\"\r\n\r\nlet reactiveWeakMap = new WeakMap()\r\nlet shallowReactiveHandlerWeakMap = new WeakMap()\r\nlet readonlyWeakMap = new WeakMap()\r\nlet shallowReadonlyWeakMap = new WeakMap()\r\nexport function reactive(target: object) {\r\n    return createReactiveObject(target, reactiveHandler, reactiveWeakMap)\r\n}\r\nexport function shallowReactive(target: object) {\r\n    return createReactiveObject(target, shallowReactiveHandler, shallowReactiveHandlerWeakMap)\r\n}\r\nexport function readonly(target: object) {\r\n    return createReactiveObject(target, readonlyHandler, readonlyWeakMap)\r\n}\r\nexport function shallowReadonly(target: object) {\r\n    return createReactiveObject(target, shallowReadonlyHandler, shallowReadonlyWeakMap)\r\n}\r\n\r\nfunction createReactiveObject(target, baseHandlers, proxyMap) {\r\n    if (!isObject(target)) return target\r\n\r\n    const exitsProxy = proxyMap.get(target)\r\n    if (exitsProxy) return exitsProxy\r\n\r\n    const proxy = new Proxy(target,  baseHandlers)\r\n    proxyMap.set(target, proxy)\r\n\r\n    return proxy\r\n}"],"names":[],"mappings":"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"}