## 第1讲: 项目概述

![课程概述](./02.pic/001.jpg)

![知识点](./02.pic/002.jpg)

![架构图设计](./02.pic/003.jpg)

![功能开发](./02.pic/004.jpg)

![线上环境](./02.pic/005.jpg)

![课程收货](./02.pic/006.jpg)















## 第2讲: 项目概述

### 2.1 技术选型: 

- 框架选型(koa2 vs express vs egg)
    - express: 基于回调函数, 并不友好
    - koa2: 基于异步函数async/await
    - egg: 相当于koa2的再封装, 套路式的开发web server

&nbsp;
- 数据库选型(mysql vs mongodb)
    - mysql: 企业使用更广泛且成本低(关系型数据库)
    - mongodb: 更适合一些零散的不重要的数据存储, 如:播放时间(非关系型数据库)

&nbsp;
- 登录技术(session vs jwt)
    - session: 广泛, 页面统一的项目
    - jwt: 流行, 更适合前后端分离, 多端的项目

&nbsp;
- 前端页面(ejs模板引擎 vs vue/react前端框架)
    - ejs: 后台使用
    - vue/react: 前端框架

&nbsp;
- 缓存数据库(redis)
    - redis: 主流, 没有其他竞争对手

&nbsp;
- 单元测试(jest)
    - jest: 主流、简单易用, 支持多框架
  
最终选型: koa2+mysql+session+ejs+redis+jest  
选型过程:  
1. koa2可以更好理解整个过程, 相当于学习一边egg的封装过程
2. 基于主流技术
3. 最后会补充jwt使用
4. 更专注于后台开发,不关注前端vue/react 

### 2.2 介绍koa2-创建项目:

```
// 1.安装依赖
npm install -g koa-generator

// 2.创建项目(-e: 使用ejs)
koa2 -e koa2-weibo-code

// 3.安装依赖跑起来
npm i
npm run dev

// 4.访问
访问localhost:3000

// 5.添加环境变量
npm i cross-env

// 6.修改项目环境变量，package.json
"dev": "cross-env NODE_ENV=dev ./node_modules/.bin/nodemon --inspect=9229 bin/www",
"prd": "cross-env NODE_ENV=production pm2 start pm2.conf.json",
```

### 2.3 介绍koa2-代码结构

```
// 1.调整代码结构
// 把public、routes、views、app.js放到src文件夹

// 2.修改bin/www启动文件
var app = require('../src/app');
```

![整体文件结构](./02.pic/007.jpg)

![路由文件结构](./02.pic/008.jpg)

### 2.4 介绍koa2-开发路由

src/routes/index.js

```
// get动态参数
router.get('/profile/:username', async (ctx, next) => {
  const { username } = ctx.params
  ctx.body = {
    title: 'this is profile page',
    username
  }
})

router.get('/loadMore/:username/:pageIndex', (ctx, next) => {
  const { username, pageIndex } = ctx.params
  ctx.body = {
    title: 'this is profile page',
    username,
    pageIndex
  }
})
```

src/routes/users.js

```
//post获取参数
router.post('/login', async (ctx, next) => {
  const {userName, password} = ctx.request.body
  ctx.body = {
    id: 100,
    userName,
    password
  }
})
```

### 2.5 介绍ejs-变量和判断、循环和组件

ejs语法: `<% js语法写这 %>`, `<%= 要保留在html的值写这 %>`, 不确实是否存在的值添加local`<%= local.xxxx %>`　　
示例:  
```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件列表</title>
</head>
<body>
    <h1><%=pathname%></h1>
    
    <!-- 循环 -->
    <%dirs.forEach((item) => {%>
        <p><a href="<%=item.url%>"><%=item.dir%></a></p>
    <%})%>
    
    <!-- 判断 -->
    <% if(isMe) { %>
        <a href='#'>@ 提到我的(3)</a>
    <% } else { %>
        <button>关注我</button>
    <% } %>
    
    <!--组件(组件内可写script标签)-->
    <%- include('widgets/userInfo', {
        msg
    })%>
</body>
</html>
```

>　以上做的就是SSR!

### 2.6 介绍mysql

见博客内另一篇文章















## 第3讲: 介绍登录

### 3.1 介绍redis 

见博客内另一篇文章

确保本机安装好redis即可。

### 3.2 微博项目使用redis

```
npm i redis
```

#### 3.2.1 src/conf/db.js

```
/**
 * @description 存储配置
 * @author 学浪
 */
const {NODE_ENV, ENVS} = require('../utils/env')

let REDIS_CONF = {
    [ENVS.DEV]: {
        host: '127.0.0.1',
        port: 6379
    },
    [ENVS.PRD]: {
        host: '127.0.0.1',
        port: 6379
    },
}

module.exports = {
    REDIS_CONF: REDIS_CONF[NODE_ENV]
}
```

#### 3.2.2 src/cache/_redis.js

```
/**
 * @description 连接 redis 的方法 get set
 * @author 学浪
 */

const {createClient} = require('redis');
const {REDIS_CONF} = require('../conf/db')

// 创建客户端
const client = createClient(REDIS_CONF.port, REDIS_CONF.host);
client.on('error', (err) => console.log('Redis Client Error', err));
client.connect().then(() => {
    console.log('连接redis成功')
}).catch((err) => {
    console.log('连接redis失败:', err)
})

/**
 * @description 获取
 * @param key 键
 */
async function get(key) {
    const value = await client.get(key)
    try {
        return JSON.parse(value)
    } catch(err) {
        return value
    }
}

/**
 * 设置
 * @param key 键
 * @param val 值
 * @param timeout 过期时间, 单位 s
 */
async function set(key, val, timeout = 60 * 60) {
    if(typeof val === 'object') val = JSON.stringify(val)
    await client.set(key, val)
    await client.expire(key, timeout)
}

module.exports = {
    get,
    set
}
```

#### 3.2.3 src/utils/env.js

```
/**
 * @description 环境变量
 * @author 学浪
 */

const NODE_ENV = process.env.NODE_ENV;
const ENVS = {
    'DEV': 'dev',
    'PRD': 'prd',
}

module.exports = {
    NODE_ENV,
    ENVS,
    isDev: NODE_ENV === ENVS.DEV,
    notDev: NODE_ENV !== ENVS.DEV,
    isPrd: NODE_ENV === ENVS.PRD,
    notPrd: NODE_ENV !== ENVS.PRD,
}
```

### 3.3 微博项目使用redis2

cookie: 存储session的key
session: 存储用户信息

#### 3.3.1 koa2使用session,并存到redis

```
npm i koa-redis koa-generic-session -S
```

src/app.js

```
const session = require('koa-generic-session')
const redisStore = require('koa-redis')
const {REDIS_CONF} = require('./conf/db')

// session配置
app.keys = ['UIsda_8967#$']
app.use(session({
    key: 'weibo.sid', //cookie的name
    prefix: 'weibo:sess:', //redis key的前缀, 默认`koa:sess:`
    cookie: {
        path: '/',
        httpOnly: true, //只能服务端修改cookie
        maxAge: 24 * 60 * 60 * 1000, //ms
    },
    // ttl: 24 * 60 * 60 * 1000,
    store: redisStore({
        all: `${REDIS_CONF.host}:${REDIS_CONF.port}`
    })
}))
```

src/routes/users.js (需要使用一下session, 中间件才会生效)

```
router.get('/session', function (ctx, next) {
    let session = ctx.session
    if(session.viewCount == null) {
        session.viewCount = 0
    }else {
        session.viewCount++
    }
    ctx.body = {
        title: '测试redis session',
        viewCount: session.viewCount
    }
})
```

浏览器访问: http://localhost:3000/users/session,  
服务端操作session(中间件的,已经指向redis),   
中间件返回session的key给前端的cookie  

### 3.4 jest基础使用

- expect(10+20).toBe(30)
- expect({a: 'b'}).toEqual({a: 'b'})

#### 3.4.1 jest可行性测试

```
npm i jest -D
```

添加运行命令 (package.json)

```
"test": "cross-env NODE_ENV=test jest --runInBand --forceExit --colors"
```

添加测试用例 (/test/example.test.js)

```
/**
 * @description 测试jest可用性
 * @author 学浪
 */

function add(a, b) {
    return a + b
}
test('10 + 20 = 30', () => {
    let count = add(10, 20)
    expect(count).toBe(30)
})
```

#### 3.4.1 jest测试http请求

```
npm i supertest -D
```

使用supertest测试项目 (/test/server.js)

```
const request = require('supertest')
const server = require('../src/app').callback()

module.exports = request(server)
```

添加测试用例 (/test/example.test.js)

```
/**
 * get测试
 */
test('接口测试: /json', async () => {
    const res = await server.get('/json')
    expect(res.body).toEqual({title: 'koa2 json'})
})

/**
 * post测试
 */
test('接口测试: /json', async () => {
    const res = await server.post('/postjson').send({
        message: '123'
    })
    expect(res.body).toEqual({title: '123'})
})
```

添加路由 (src/routes/index.js)

```
router.get('/json', async (ctx, next) => {
  // 返回json
  ctx.body = {
    title: 'koa2 json'
  }
})

router.post('/postjson', async (ctx, next) => {
    const {message} = ctx.request.body
    ctx.body = {
        title: message
    }
})

```

### 3.5 koa2开发环境完善

#### 1. eslint

```
npm install eslint @babel/eslint-parser -D
```

package.json

```
"lint": "eslint --ext .js ./src",
// 可以加--fix来自动修复一些问题
```

/.eslintrc.json

```
{
    "parser": "@babel/eslint-parser",
    "parserOptions": {
        "requireConfigFile": false
    },
    "env": {
        "es6": true,
        "commonjs": true,
        "node": true
    },
    "rules": {
        "indent": ["error", 4],
        "quotes": [
            "error",
            "single",
            {
              "allowTemplateLiterals": true
            }
        ],
        "semi": [
            "error",
            "never"
        ]
    }
}
```

/.eslintignore

```
node_modules
test
src/public
```

跑一次命令, npm run lint

#### 2. 调试

- package.json添加`--inspect=9229`

```
"dev": "cross-env NODE_ENV=dev ./node_modules/.bin/nodemon --inspect=9229 bin/www",
```

- 启动项目 `npm run dev`  
- 访问chrome/edge: `chrome://inspect/#devices`  
- 代码内添加 `debugger`

![inspect调试](./02.pic/029.jpg)

- 也可以选择在webstorm中调试, 直接下面截图的即可

![webstorm调试](./02.pic/030.jpg)

#### 3. 404和error页

添加自己想要的404和error的ejs页面到src/views内

src/routes/view/error.js

```
/**
 * @description error 404 路由
 * @author 学浪
 */

const router = require('koa-router')()

router.get('/error', async (ctx, next) => {
    await ctx.render('error')
})

router.get('*', async (ctx, next) => {
    await ctx.render('404')
})

module.exports = router
```

src/app.js

```
+ const {isPrd} = require('./utils/env')
+ const errorViewRouter = require('./routes/view/error')
 
- onerror(app)
+ let onErrorConf = {}
+ if (isPrd) onErrorConf = {redirect: 'error'}
+ onerror(app, onErrorConf)
 
+ app.use(errorViewRouter.routes(), errorViewRouter.allowedMethods())
```

### 3.6 jwt

#### 1.jwt是什么

![jwt是什么](./02.pic/031.jpg)

原本是明文访问用户信息, 但有危险, 所以返回jwt加密的。

因为用户信息存储在客户端, 服务端比较不好控制。如踢人。

#### 2.koa2实现jwt

##### 服务器设置token

```
koa2 -e 05.jwt-test
cd 05.jwt-test
npm i koa-jwt -S // 中间件: 各个路由验证token
npm i jsonwebtoken -S // 加密成token, 配置有效期
```

src/app.js

```
const jwt = require('koa-jwt')
const {SECRET} = require('./conf/constants')

app.use(jwt({
    secret: SECRET
}).unless({
    path: [/^\/users\/login/] // 定义哪些路由不使用该中间件
}))
```

conf/constants.js

```
module.exports = {
    SECRET: 'uhKSO_231$J'
}
```

/routes/users.js

```
const jwt = require('jsonwebtoken')
const {SECRET} = require('../conf/constants')

router.post('/login', async (ctx, next) => {
    let {userName, password} = ctx.request.body

    let userInfo
    if (userName === 'lisi' && password === '123') {
        userInfo = {
            id: 1,
            userName: 'lisi',
            nickName: '李四',
            phone: '13511132356'
        }

        let token = jwt.sign(userInfo, SECRET, { expiresIn: '1h'})

        ctx.body = {
            error: 0,
            data: token
        }
    } else {
        ctx.body = {
            error: -1,
            meg: '登录失败'
        }
    }
})
```

> 在没token的时候, 访问/json, 返回401页面

##### 客户端使用token获取用户信息

postman 带token请求

![postman Header带token请求](./02.pic/032.jpg)

服务端处理token

/routes/users.js

```
const util = require('util')
const verify = util.promisify(jwt.verify)

router.get('/getUserInfo', async (ctx, next) => {
    let token = ctx.header.authorization
    try {
        const payload = await verify(token.split(' ')[1], SECRET)
        ctx.body = {
            error: 0,
            userInfo: payload
        }
    }catch (err) {
        console.log(err)
        ctx.body = {
            error: -1,
            msg: 'verify token failed'
        }
    }
})
```

#### 3.jwt vs session

![jwt vs session 1](./02.pic/033.jpg)

![jwt vs session 2](./02.pic/034.jpg)














## 第4讲: 技术方案设计

### 4.1 构架图(模块划分、层次先后关系)

![jwt vs session 2](./02.pic/035.jpg)

### 4.2 页面和API设计

![页面和API 01](./02.pic/036.jpg)

![页面和API 02](./02.pic/037.jpg)

![页面和API 03](./02.pic/038.jpg)

![页面和API 04](./02.pic/039.jpg)

![页面和API 05](./02.pic/040.jpg)

![页面和API 06](./02.pic/041.jpg)

![页面和API 07](./02.pic/042.jpg)

![页面和API 08](./02.pic/043.jpg)

![页面和API 09](./02.pic/044.jpg)

路由汇总

![页面和API 10](./02.pic/045.jpg)

API汇总

![页面和API 11](./02.pic/046.jpg)

![页面和API 12](./02.pic/047.jpg)

### 4.2 数据模型设计(数据库表)

- ER图
  ![ER图 表关系](./02.pic/050.jpg)


- 关系型数据库 三大范式
  ![三大范式](./02.pic/048.jpg)
  ![三大范式 优势](./02.pic/049.jpg)


- 数据模型设计
    - 见ER图

### 4.3 其他 (单独功能, 不划分在设计里)

- @功能如何实现?
- 图片上传如何实现?















## 第5讲: 功能列表及开发顺序

![功能列表01](./02.pic/051.jpg)

![功能列表02](./02.pic/052.jpg)

![功能列表03](./02.pic/053.jpg)















## 第5讲: 用户管理

### 5.1 注册页

![页面和API 01](./02.pic/036.jpg)

添加ejs模板

src/views/register.ejs

```
<%- include('layout/header', { title: '微博 - 注册', isNarrow: true })%>

<h1>注册</h1>
<% if (locals.isLogin) { %>
    <p><%= locals.userName%> 您已成功登录，请直接访问<a href="/">首页</a></p>
<% } else { %>
    <form>
        <div class="form-group">
            <input type="text" class="form-control" id="input-username" placeholder="请输入用户名">
            <small id="span-username-info" class="form-text text-muted"></small>
        </div>
        <div class="form-group">
            <input type="password" class="form-control" id="input-password" placeholder="请输入密码">
        </div>
        <div class="form-group">
            <input type="password" class="form-control" id="input-password-repeat" placeholder="重新输入密码">
            <small id="span-password-repeat-info" class="form-text text-muted"></small>
        </div>
        <div class="form-group">
            <select class="form-control" id="select-gender">
                <option value="1">男</option>
                <option value="2">女</option>
                <option value="3">保密</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary" id="btn-submit">注册</button>
        &nbsp;
        <a href="/login">已有账号，返回登录>></a>
    </form>

    <script>
        $(function() {
            var $inputUserName = $('#input-username')
            var $spanUserNameInfo = $('#span-username-info')
            var $inputPassword = $('#input-password')
            var $inputPasswordRepeat = $('#input-password-repeat')
            var $spanPasswordRepeatInfo = $('#span-password-repeat-info')
            var $selectGender = $('#select-gender')
            var userNameTimeoutId
            var passwordTimeoutId
            var isPasswordSame = false // 默认两次密码不一致
            var isUserNameExist = true // 默认用户名已存在

            // 监听用户名输入
            $inputUserName.on('input', function() {
                // 做一个简单的防抖
                if (userNameTimeoutId) {
                    clearTimeout(userNameTimeoutId)
                }
                userNameTimeoutId = setTimeout(function() {
                    // 判断用户名是否已存在
                    var userName = $inputUserName.val()
                    ajax.post('/api/user/isExist', {
                        userName
                    }, function(err, data) {
                        $spanUserNameInfo.show()
                        if (err) {
                            $spanUserNameInfo.text('用户名可用')
                            isUserNameExist = false
                        } else {
                            $spanUserNameInfo.text('用户名已存在！')
                            isUserNameExist = true
                        }
                    })
                }, 500)
            })

            // 监听验证密码输入
            $inputPasswordRepeat.on('input', function () {
                // 做一个简单的防抖
                if (passwordTimeoutId) {
                    clearTimeout(passwordTimeoutId)
                }
                passwordTimeoutId = setTimeout(function() {
                    var password = $inputPassword.val()
                    var passwordRepeat = $inputPasswordRepeat.val()
                    $spanPasswordRepeatInfo.show()
                    if (password === passwordRepeat) {
                        $spanPasswordRepeatInfo.text('两次密码一致')
                        isPasswordSame = true
                    } else {
                        $spanPasswordRepeatInfo.text('两次密码不一致！')
                        isPasswordSame = false
                    }
                }, 500)
            })

            // 注册事件
            $('#btn-submit').click(function(e) {
                // 阻止默认的提交表单行为
                e.preventDefault()

                // 验证
                if (isUserNameExist) {
                    alert('用户名已存在')
                    return
                }
                if (!isPasswordSame) {
                    alert('两次密码不一致')
                    return
                }

                var userName = $inputUserName.val()
                var password = $inputPassword.val()
                var gender = parseInt($selectGender.val())

                // 提交数据
                ajax.post('/api/user/register', {
                    userName,
                    password,
                    gender
                }, function(err, data) {
                    if (err) {
                        alert(err)
                        return
                    }
                    alert('注册成功，请登录')
                    location.href = '/login'
                })
            })
        })
    </script>
<% } %>

<%- include('layout/footer')%>
```

src/views/login.ejs

```
<%- include('layout/header', { title: '微博 - 登录', isNarrow: true })%>

<h1>登录</h1>
<% if (locals.isLogin) { %>
    <p><%= locals.userName%> 您已成功登录，请直接访问<a href="/">首页</a></p>
<% } else { %>
    <form>
        <div class="form-group">
            <input type="text" class="form-control" id="input-username" placeholder="请输入用户名">
        </div>
        <div class="form-group">
            <input type="password" class="form-control" id="input-password" placeholder="请输入密码">
        </div>
        <button type="submit" class="btn btn-primary" id="btn-submit">登录</button>
        &nbsp;
        <a href="/register">注册账号>></a>
    </form>

    <script>
        $(function() {
            var $inputUserName = $('#input-username')
            var $inputPassword = $('#input-password')
            $('#btn-submit').click(function(e) {
                // 阻止默认的提交表单行为
                e.preventDefault()
                const userName = $inputUserName.val()
                const password = $inputPassword.val()

                // 提交数据
                ajax.post('/api/user/login', {
                    userName,
                    password
                }, function(err, data) {
                    if (err) {
                        alert(err)
                        return
                    }
                    // 跳转到指定 url 或首页
                    var redirectUrl = $.query.get('url') || '/'
                    location.href = redirectUrl
                })
            })
        })
    </script>
<% } %>

<%- include('layout/footer')%>
```

添加路由

src/routes/view/user.js

```
/**
 * @description sequelize 实例
 * @author 学浪
 */

const router = require('koa-router')()

router.get('/login', async (ctx, next) => {
    await ctx.render('login', {})
})

router.get('/register', async (ctx, next) => {
    await ctx.render('register', {})
})

module.exports = router
```

src/app.js

```
+ const userViewRouter = require('./routes/view/user')

+ app.use(userViewRouter.routes(), userViewRouter.allowedMethods())
```

### 5.2 user模型

1.新建用户的模型

src/db/model/User.js

```
/**
 * @description 模型 user表
 * @author 学浪
 */

const seq = require('../seq')
const {STRING, DECIMAL} = require('../type')

const User = seq.define('user', {
    // 自动创建: id, 并设为主键、自增
    // 自动创建: createAt 和 updateAt
    userName: {
        type: STRING, // varchar(255)
        allowNull: false,
        unique: true,
        comment: '用户名'
    },
    password: {
        type: STRING, // varchar(255)
        allowNull: false,
        comment: '密码'
    },
    nickName: {
        type: STRING, // varchar(255),
        allowNull: false,
        comment: '昵称'
    },
    gender: {
        type: DECIMAL, // DECIMAL(10,0)
        allowNull: false,
        defaultValue: 3,
        comment: '性别（1 男性，2 女性，3 保密）'
    },
    picture: {
        type: STRING, // varchar(255),
        comment: '头像 图片地址'
    },
    city: {
        type: STRING, // varchar(255),
        comment: '城市'
    },
})

module.exports = User
```

2.封装一个seq的类型

src/db/types.js

```
const Sequelize = require('sequelize')

module.exports = {
    STRING: Sequelize.STRING,
    DECIMAL: Sequelize.DECIMAL,
    TEXT: Sequelize.TEXT,
    INTEGER: Sequelize.INTEGER,
    BOOLEAN: Sequelize.BOOLEAN
}
```

3.因为模型会很多，所以添加一个入口文件

src/db/model/index.js

```
const User = require('./User')

module.exports = {
    User
}
```

4.执行一下同步

src/db/sync.js

```
require('./model');
```

### 5.2 登录页

![页面和API 02](./02.pic/037.jpg)




















## 第99讲: 坑

#### 1. Client does not support authentication protocol requested by server

```
npm i mysql 改为 npm i mysql2
```





































